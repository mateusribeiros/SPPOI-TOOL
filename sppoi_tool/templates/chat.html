{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SPPOI Tool</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<style>
		:root {
			--c-cream: #EFF6E0;
			--c-sage: #AEC3B0;
			--c-mist: #598392;
			--c-deep: #124559;
			--c-night: #01161E;
		}
		body { background: var(--c-cream); }
		.sidebar { background: linear-gradient(180deg, var(--c-night) 0%, #06232d 100%); color: #fff; min-height: 100vh; }
		.sidebar a { color: #e7f5ef; text-decoration: none; }
		.chat-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.08); margin-bottom:8px; border: 1px solid rgba(255,255,255,0.08); }
		.chat-item:hover { background: rgba(255,255,255,0.16); }
		.chat-item a { flex:1; color:#f4fff9; }
		.chat-item .chat-link { flex:1; background: transparent; border: 0; color:#f4fff9; text-align:left; padding:0; }
		.chat-item .chat-link:hover { color:#ffffff; }
		.chat-item-actions button { border:0; background:transparent; color:#ffcece; }
		.chat-item-actions button:hover { color:#ff9b9b; }
		.data-list { display:flex; flex-direction:column; gap:8px; }
		.data-item { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:12px; background:#ffffff; border:1px solid #e2ece4; box-shadow: 0 4px 10px rgba(1, 22, 30, 0.06); }
		.data-item-content { display:flex; flex-direction:column; gap:2px; }
		.data-item-title { font-weight:600; color: var(--c-night); }
		.data-item-sub { color: var(--c-deep); font-size:0.85rem; }
		.data-item-meta { color: var(--c-mist); font-size:0.78rem; }
		.data-item-actions { display:flex; gap:6px; }
		.data-item-actions button { background:#eef5f0; border:1px solid #dbe7df; color: var(--c-deep); border-radius:8px; padding:4px 6px; }
		.data-item-actions button:hover { background: var(--c-deep); color:#fff; border-color: var(--c-deep); }
		.data-item-actions .delete-btn { background:#fff1f1; border-color:#f4c7c7; color:#b91c1c; }
		.data-item-actions .delete-btn:hover { background:#b91c1c; color:#fff; border-color:#b91c1c; }
		.data-empty { background:#f5f9f0; border:1px dashed #dbe7df; border-radius:10px; padding:10px; color: var(--c-mist); font-size:0.85rem; text-align:center; }
		.empty-state { background: #f5f9f0; border: 1px dashed var(--c-sage); border-radius: 12px; padding: 18px; text-align: center; color: var(--c-deep); }
		.top-message { background: #ffffff; border: 1px solid #dbe7df; border-radius: 12px; padding: 12px 16px; color: var(--c-night); box-shadow: 0 6px 16px rgba(1, 22, 30, 0.06); }
		.top-message .title { font-weight: 700; color: var(--c-deep); }
		.jump-consult { position: sticky; top: 16px; display:flex; justify-content:center; }
		.btn-jump { border-radius: 999px; background: var(--c-deep); border-color: var(--c-deep); color: #fff; }
		.btn-jump:hover { background: #0f3d4f; border-color: #0f3d4f; color: #fff; }
		.chat-area { background: #fff; border-radius: 14px; padding: 16px; min-height: 70vh; border: 1px solid var(--c-sage); }
		.msg { padding: 12px 14px; margin-bottom: 12px; border-radius: 12px; }
		.msg.user { background: #e6f0ea; border: 1px solid var(--c-sage); }
		.msg.assistant { background: #edf6f3; border: 1px solid #d3e4dc; }
		.prompt-box { background: var(--c-night); color: #e6f2ed; padding: 14px; border-radius: 12px; max-height: 240px; overflow: auto; border: 1px solid #0b2a36; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9rem; }
		.prompt-card { background: #fff; border-radius: 14px; border: 1px solid #dbe7df; box-shadow: 0 8px 24px rgba(1, 22, 30, 0.08); }
		.prompt-actions .btn { font-size: 0.85rem; border-color: var(--c-mist); color: var(--c-deep); }
		.prompt-actions .btn:hover { background: var(--c-deep); color: #fff; border-color: var(--c-deep); }
		.analysis-actions .btn { font-size: 0.85rem; border-color: var(--c-mist); color: var(--c-deep); }
		.analysis-actions .btn:hover { background: var(--c-deep); color: #fff; border-color: var(--c-deep); }
		.prompt-meta { color: var(--c-mist); font-size: 0.85rem; }
		.prompt-toolbar { border-bottom: 1px solid #eef2f7; }
		.prompt-title { display: flex; align-items: center; gap: 8px; color: var(--c-night); }
		.prompt-box code { color: #b8e0d2; }
		.panel { background: #fff; border-radius: 16px; padding: 14px; border: 1px solid #dbe7df; box-shadow: 0 6px 18px rgba(1, 22, 30, 0.06); }
		.panel h6 { margin-top: 8px; color: var(--c-night); }
		.badge-soft { background: #e9f2ee; color: var(--c-deep); }
		.status-pill { display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px; font-weight:600; font-size:0.95rem; border:1px solid #dbe7df; background:#f7fbf6; color: var(--c-deep); box-shadow: 0 6px 16px rgba(1, 22, 30, 0.08); }
		.status-pill.is-new { background: #eef2ff; color: #3730a3; border-color: #c7d2fe; }
		.status-pill.is-running { background: #fef3c7; color: #92400e; border-color: #fde68a; }
		.status-pill.is-ready { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
		.form-control, .form-select { margin-bottom: 10px; border-radius: 12px; border-color: #cfe0d6; background: #f9fbf8; }
		.form-control::placeholder { color: #7b8f86; }
		.form-control:focus, .form-select:focus { border-color: var(--c-mist); box-shadow: 0 0 0 0.2rem rgba(88, 131, 146, 0.2); background: #fff; }
		.form-select[multiple] { min-height: 120px; }
		.multi-hint { font-size: 0.78rem; color: var(--c-mist); margin-top: -6px; margin-bottom: 10px; }
		.streaming { border-left: 4px solid var(--c-mist); }
		.accordion-button { background: #f3f7f2; color: var(--c-deep); }
		.accordion-button:not(.collapsed) { background: #e7f0ea; color: var(--c-night); }
		.acc-ok { background: var(--c-deep) !important; color: #fff !important; }
		.acc-ok::after { filter: invert(1); }
		.acc-missing { background: #f7fbf6 !important; color: var(--c-mist) !important; }
		.acc-label { display:flex; align-items:center; gap:10px; width:100%; }
		.req-pill { margin-left:auto; font-size:0.75rem; padding:4px 8px; border-radius:999px; border:1px solid #dbe7df; background:#eef5f0; color: var(--c-mist); }
		.acc-ok .req-pill { background:#ffffff1f; color:#fff; border-color:#ffffff33; }
		.btn-primary { background: var(--c-deep); border-color: var(--c-deep); }
		.btn-primary:hover { background: #0f3d4f; border-color: #0f3d4f; }
		.btn-outline-secondary { border-color: var(--c-mist); color: var(--c-deep); }
		.btn-outline-secondary:hover { background: var(--c-mist); color: #fff; }
		.btn-light { color: var(--c-night) !important; }
		.btn-light:hover { color: var(--c-night) !important; }
		.btn-new-chat { color: var(--c-night) !important; }
		.section-card { background: #f9fbf7; border: 1px solid #dbe7df; border-radius: 14px; padding: 12px; margin-bottom: 12px; }
		.section-card .section-title { display:flex; align-items:center; gap:8px; color: var(--c-deep); font-weight: 600; margin-bottom: 8px; }
		.panel .section-title { margin-bottom: 12px; }
		.btn-consult { background: linear-gradient(135deg, #124559, #1b6f8a); border-color: #1b6f8a; color: #fff; font-weight: 700; border-radius: 12px; padding: 10px 18px; box-shadow: 0 10px 22px rgba(27, 111, 138, 0.28); transition: transform 0.15s ease, box-shadow 0.15s ease; }
		.btn-consult:hover { background: linear-gradient(135deg, #0f3d4f, #155d72); border-color: #155d72; transform: translateY(-1px); box-shadow: 0 12px 24px rgba(21, 93, 114, 0.32); }
		.btn-clear { border-color: #f97316; color: #fff; background: linear-gradient(135deg, #f97316, #f59e0b); font-weight: 700; border-radius: 12px; padding: 10px 16px; box-shadow: 0 10px 22px rgba(245, 158, 11, 0.28); }
		.btn-clear:hover { background: linear-gradient(135deg, #ea580c, #d97706); border-color: #d97706; }
	</style>
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-md-2 sidebar p-3">
			<div class="d-flex align-items-center mb-3">
				<i class="bi bi-chat-dots-fill me-2"></i>
				<strong data-i18n="conversations">Conversas</strong>
			</div>
			<div class="mb-3">
				<select id="lang-toggle" class="form-select form-select-sm">
					<option value="pt">Português (Brasil)</option>
					<option value="en">English</option>
				</select>
			</div>
			<a class="btn btn-sm btn-light w-100 mb-2 btn-new-chat" href="{% url 'chat_new' %}" data-i18n="new_chat">Nova conversa</a>
			<a class="btn btn-sm btn-outline-secondary w-100 mb-3" href="{% url 'index' %}">
				<i class="bi bi-house-door me-1"></i><span data-i18n="back_home">Voltar ao início</span>
			</a>
			<div id="chat-list">
				{% if projects %}
					{% for p in projects %}
						<div class="chat-item">
							<button type="button" class="chat-link select-chat-btn" data-id="{{ p.id }}">{{ p.nome }}</button>
							<div class="chat-item-actions">
								<button type="button" title="Excluir conversa" data-id="{{ p.id }}" class="delete-chat-btn">
									<i class="bi bi-trash"></i>
								</button>
							</div>
						</div>
					{% endfor %}
				{% else %}
					<div class="small text-muted" data-i18n="no_conversations">Nenhuma conversa criada.</div>
				{% endif %}
			</div>
		</div>
		<div class="col-md-7 p-4">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="mb-0">{{ project.nome }}</h5>
				<span class="status-pill is-new" id="status-badge">
					<i class="bi bi-stars"></i><span data-i18n="status_new">Status: Novo</span>
				</span>
			</div>

			<div class="top-message mb-3">
				<div class="title">SPPOI Tool</div>
				<div data-i18n="top_message">Registre sistemas, interfaces e estilos de integração para iniciar a análise.</div>
			</div>

			<div class="jump-consult mb-2" style="display:none;">
				<button class="btn btn-jump btn-sm" id="jump-consult" data-jump="down">
					<i class="bi bi-arrow-down-circle me-1"></i><span data-i18n="scroll_down">Descer a página</span>
				</button>
			</div>

			<div class="mt-3" id="consult-actions">
				<div class="d-flex gap-2 mt-2">
					<button class="btn btn-consult" id="send-btn"><i class="bi bi-search me-1"></i><span data-i18n="analysis">Análise Técnica</span></button>
					<button class="btn btn-clear" id="clear-btn"><i class="bi bi-eraser me-1"></i><span data-i18n="clear_screen">Limpar tela</span></button>
				</div>
				<div class="text-danger mt-2" id="error-msg" style="display:none;"></div>
			</div>

			<div class="mt-3">
				<div class="d-flex justify-content-between align-items-center mb-2">
					<div class="fw-semibold" data-i18n="generated_analysis">Análise gerada</div>
					<div class="analysis-actions d-flex gap-2">
						<button class="btn btn-outline-secondary btn-sm" id="analysis-copy">
							<i class="bi bi-clipboard me-1"></i><span data-i18n="copy">Copiar</span>
						</button>
						<button class="btn btn-outline-secondary btn-sm" id="analysis-download">
							<i class="bi bi-download me-1"></i><span data-i18n="download">Baixar</span>
						</button>
					</div>
				</div>
				<div class="chat-area" id="chat-area"></div>
				<div class="empty-state mt-3" id="empty-state" style="display:none;">
					<span data-i18n-html="no_analysis">Nenhuma análise gerada ainda. Clique em <strong>Análise Técnica</strong> para começar.</span>
				</div>
			</div>

			<div class="mt-4">
				<div class="prompt-card">
					<div class="prompt-toolbar d-flex justify-content-between align-items-center p-3">
						<div class="prompt-title">
							<i class="bi bi-terminal"></i>
							<div>
								<div class="fw-semibold" data-i18n="prompt_used">Prompt utilizado</div>
								<div class="prompt-meta" data-i18n="prompt_meta">Somente leitura • Para fins de transparência das técnicas aplicadas.</div>
							</div>
						</div>
						<div class="prompt-actions d-flex gap-2">
							<button class="btn btn-outline-secondary btn-sm" id="prompt-toggle">
								<i class="bi bi-arrows-angle-expand me-1"></i><span data-i18n="expand">Expandir</span>
							</button>
							<button class="btn btn-outline-secondary btn-sm" id="prompt-copy">
								<i class="bi bi-clipboard me-1"></i><span data-i18n="copy">Copiar</span>
							</button>
							<button class="btn btn-outline-secondary btn-sm" id="prompt-download">
								<i class="bi bi-download me-1"></i><span data-i18n="download">Baixar</span>
							</button>
						</div>
					</div>
					<div class="p-3">
						<pre class="prompt-box" id="prompt-box" data-i18n="prompt_placeholder">(O prompt aparecerá aqui após a consulta.)</pre>
					</div>
				</div>
			</div>
		</div>

		<div class="col-md-3 p-3">
			<div class="panel mb-3">
				<div class="section-title d-flex align-items-center justify-content-between">
					<div><i class="bi bi-sliders"></i><span data-i18n="registration">{% trans "Cadastro" %}</span></div>
					<button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal">
						<i class="bi bi-lightbulb me-1 text-warning"></i><span data-i18n="example">{% trans "Exemplo" %}</span>
					</button>
				</div>
				<div class="accordion" id="dataAccordion">
					<div class="accordion-item">
						<h2 class="accordion-header" id="headingSystems">
							<button class="accordion-button collapsed acc-missing" id="acc-systems" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystems" aria-expanded="false" aria-controls="collapseSystems">
								<span class="acc-label"><i class="bi bi-diagram-3"></i> <span data-i18n="systems">{% trans "Sistemas" %}</span> <span class="req-pill" data-i18n="minimum_2">{% trans "mínimo 2" %}</span></span>
							</button>
						</h2>
						<div id="collapseSystems" class="accordion-collapse collapse" aria-labelledby="headingSystems" data-bs-parent="#dataAccordion">
							<div class="accordion-body">
								<div id="systems-list" class="mb-3"></div>
								<form id="system-form">
					<input type="hidden" id="system-id" name="system_id">

					<h6 class="mt-2" data-i18n="section_identity">{% trans "Identidade" %}</h6>
					<label class="form-label" data-i18n="system_id">{% trans "ID do sistema" %}</label>
					<input class="form-control" name="system_identifier" placeholder="{% trans 'Ex: SYS-ERP-01' %}" data-i18n-placeholder="system_id_ph" readonly>
					<label class="form-label" data-i18n="system_name">{% trans "Nome do sistema" %}</label>
					<input class="form-control" name="nome" placeholder="{% trans 'Ex: ERP Corporativo' %}" data-i18n-placeholder="system_name_ph" required>

					<label class="form-label" data-i18n="system_type">{% trans "Tipo de sistema" %}</label>
					<select class="form-select" name="tipo" id="system-type" required>
						<option selected disabled value="" data-i18n="system_type">{% trans "Tipo de sistema" %}</option>
						<option value="ERP">ERP</option>
						<option value="CRM">CRM</option>
						<option value="Gateway">Gateway</option>
						<option value="Analytics">Analytics</option>
						<option value="CMS">CMS</option>
						<option value="E-commerce">E-commerce</option>
						<option value="IAM">IAM</option>
						<option value="IoT">IoT</option>
						<option value="Outro" data-i18n="other_describe">{% trans "Outro (descrever)" %}</option>
					</select>
					<input class="form-control" id="system-type-other" name="tipo_outro" placeholder="{% trans 'Ex: Mainframe legado' %}" data-i18n-placeholder="system_type_other_ph" style="display:none;" maxlength="80">
					<label class="form-label" data-i18n="description">{% trans "Descrição" %}</label>
					<textarea class="form-control" name="descricao" placeholder="{% trans 'Breve descrição' %}" data-i18n-placeholder="description_ph" rows="2" maxlength="300"></textarea>

					<h6 class="mt-2" data-i18n="section_arch_role">{% trans "Papel arquitetural" %}</h6>
					<label class="form-label" data-i18n="flow_role">{% trans "Papel no fluxo" %}</label>
					<select class="form-select" name="integration_role" required>
						<option selected disabled value="" data-i18n="flow_role">{% trans "Papel no fluxo" %}</option>
						<option value="Source" data-i18n="role_source">{% trans "Origem (Source)" %}</option>
						<option value="Target" data-i18n="role_target">{% trans "Destino (Target)" %}</option>
						<option value="Both" data-i18n="role_both">{% trans "Ambos (Both)" %}</option>
					</select>
					<label class="form-label" data-i18n="primary_function">{% trans "Função principal no fluxo" %}</label>
					<input class="form-control" name="primary_function_in_flow" placeholder="{% trans 'Ex: Origem de pedidos e clientes' %}" data-i18n-placeholder="primary_function_ph" maxlength="120">

					<h6 class="mt-2" data-i18n="section_tech_capabilities">{% trans "Capacidades técnicas" %}</h6>
					<label class="form-label" data-i18n="supported_protocols">{% trans "Protocolos suportados" %}</label>
					<select class="form-select multi-toggle" name="protocolos_suportados" id="protocolos_suportados" multiple>
						<option value="HTTP">HTTP</option>
						<option value="HTTPS">HTTPS</option>
						<option value="WebSocket">WebSocket</option>
						<option value="AMQP">AMQP</option>
						<option value="FTP">FTP</option>
						<option value="Outro" data-i18n="other">Outro</option>
					</select>
					<div class="multi-hint" data-i18n="multi_hint">{% trans "Clique para selecionar múltiplos." %}</div>
					<input class="form-control" id="protocolos_suportados_outro" name="protocolos_suportados_outro" placeholder="{% trans 'Ex: MQTT' %}" data-i18n-placeholder="protocol_other_ph" style="display:none;" maxlength="120">

					<label class="form-label" data-i18n="supported_data_formats">{% trans "Formatos de dados suportados" %}</label>
					<select class="form-select multi-toggle" name="capacidades_dados" id="capacidades_dados" multiple>
						<option value="JSON">JSON</option>
						<option value="XML">XML</option>
						<option value="CSV">CSV</option>
						<option value="Avro">Avro</option>
						<option value="Outro" data-i18n="other">Outro</option>
					</select>
					<div class="multi-hint" data-i18n="multi_hint">{% trans "Clique para selecionar múltiplos." %}</div>
					<input class="form-control" id="capacidades_dados_outro" name="capacidades_dados_outro" placeholder="{% trans 'Ex: Parquet' %}" data-i18n-placeholder="data_format_other_ph" style="display:none;" maxlength="120">

					<label class="form-label" data-i18n="auth_methods">{% trans "Métodos de autenticação" %}</label>
					<select class="form-select multi-toggle" name="requisitos_autenticacao" id="requisitos_autenticacao" multiple>
						<option value="OAuth2">OAuth2</option>
						<option value="API Key">API Key</option>
						<option value="Basic Auth">Basic Auth</option>
						<option value="mTLS">mTLS</option>
						<option value="None" data-i18n="none">Nenhuma</option>
						<option value="Outro" data-i18n="other">Outro</option>
					</select>
					<div class="multi-hint" data-i18n="multi_hint">{% trans "Clique para selecionar múltiplos." %}</div>
					<input class="form-control" id="requisitos_autenticacao_outro" name="requisitos_autenticacao_outro" placeholder="{% trans 'Ex: SAML' %}" data-i18n-placeholder="auth_other_ph" style="display:none;" maxlength="120">

					<button type="button" class="btn btn-sm btn-outline-secondary w-100 mb-2" id="system-advanced-toggle" data-i18n="optional_metadata">{% trans "Metadados opcionais" %}</button>
					<div id="system-advanced" style="display:none;">
						<label class="form-label" data-i18n="version">{% trans "Versão" %}</label>
						<input class="form-control" name="versao" placeholder="{% trans 'Ex: 12.4.1' %}" data-i18n-placeholder="version_ph">
						<label class="form-label" data-i18n="technical_contact">{% trans "Contato técnico" %}</label>
						<input class="form-control" name="technical_contact" placeholder="{% trans 'Ex: arq.erp@empresa.com.br' %}" data-i18n-placeholder="technical_contact_ph">
						<label class="form-label" data-i18n="technical_notes">{% trans "Observações técnicas" %}</label>
						<textarea class="form-control" name="architectural_notes" placeholder="{% trans 'Observações técnicas (se houver exceções)' %}" data-i18n-placeholder="technical_notes_ph" rows="2" maxlength="500"></textarea>
					</div>

					<button class="btn btn-sm btn-primary w-100" id="system-save-btn" data-i18n="save_system">{% trans "Salvar sistema" %}</button>
				</form>
							</div>
						</div>
					</div>

					<div class="accordion-item">
						<h2 class="accordion-header" id="headingInterfaces">
							<button class="accordion-button collapsed acc-missing" id="acc-interfaces" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInterfaces" aria-expanded="false" aria-controls="collapseInterfaces">
								<span class="acc-label"><i class="bi bi-plug"></i> <span data-i18n="interfaces">{% trans "Interfaces" %}</span> <span class="req-pill" data-i18n="minimum_1">{% trans "mínimo 1" %}</span></span>
							</button>
						</h2>
						<div id="collapseInterfaces" class="accordion-collapse collapse" aria-labelledby="headingInterfaces" data-bs-parent="#dataAccordion">
							<div class="accordion-body">
								<div id="interfaces-list" class="mb-3"></div>
								<form id="interface-form">
					<input type="hidden" id="interface-id" name="interface_id">

					<h6 class="mt-2" data-i18n="common_fields">{% trans "Campos comuns" %}</h6>
					<label class="form-label" data-i18n="interface_id">{% trans "ID da interface" %}</label>
					<input class="form-control" name="interface_identifier" placeholder="{% trans 'Ex: INT-CLIENTES-01' %}" data-i18n-placeholder="interface_id_ph" readonly>
					<label class="form-label" data-i18n="interface_name">{% trans "Nome da interface" %}</label>
					<input class="form-control" name="nome" placeholder="{% trans 'Ex: API Clientes' %}" data-i18n-placeholder="interface_name_ph" required>
					<label class="form-label" data-i18n="related_system">{% trans "Sistema relacionado" %}</label>
					<select class="form-select" name="sistema_id" id="interface-system-select" required></select>

					<label class="form-label" data-i18n="interface_type">{% trans "Tipo de interface" %}</label>
					<select class="form-select" name="tipo" id="interface-type" required>
						<option selected disabled value="" data-i18n="interface_type">{% trans "Tipo de interface" %}</option>
						<option value="REST API">REST API</option>
						<option value="SOAP">SOAP</option>
						<option value="WebSocket">WebSocket</option>
						<option value="Messaging">Messaging</option>
						<option value="File-based">File-based</option>
						<option value="Database Access">Database Access</option>
						<option value="Outro" data-i18n="other_custom">{% trans "Outro (custom)" %}</option>
					</select>
					<input class="form-control" id="interface-type-other" name="tipo_outro" placeholder="{% trans 'Ex: gRPC' %}" data-i18n-placeholder="interface_type_other_ph" style="display:none;" maxlength="80">

					<label class="form-label" data-i18n="supported_operations">{% trans "Operações suportadas" %}</label>
					<input class="form-control" name="operacoes_suportadas" placeholder="{% trans 'Ex: GET /clientes, POST /clientes' %}" data-i18n-placeholder="supported_operations_ph">
					<label class="form-label" data-i18n="authentication">{% trans "Autenticação" %}</label>
					<select class="form-select multi-toggle" name="autenticacao" id="autenticacao" multiple>
						<option value="OAuth2">OAuth2</option>
						<option value="API Key">API Key</option>
						<option value="Basic Auth">Basic Auth</option>
						<option value="mTLS">mTLS</option>
						<option value="None" data-i18n="none">{% trans "Nenhuma" %}</option>
						<option value="Outro" data-i18n="other">{% trans "Outro" %}</option>
					</select>
					<div class="multi-hint" data-i18n="multi_hint">{% trans "Clique para selecionar múltiplos." %}</div>
					<input class="form-control" id="autenticacao_outro" name="autenticacao_outro" placeholder="{% trans 'Ex: JWT' %}" data-i18n-placeholder="auth_other_ph" style="display:none;" maxlength="120">
					<label class="form-label" data-i18n="throttling">{% trans "Throttling" %}</label>
					<div class="d-flex gap-2">
						<input class="form-control" name="throttling" placeholder="Throttling (valor)" data-i18n-placeholder="throttling_value_ph">
						<input class="form-control" name="throttling_unit" placeholder="Unidade (req/s, msg/min)" data-i18n-placeholder="throttling_unit_ph">
					</div>

					<label class="form-label" data-i18n="technical_description">{% trans "Descrição técnica" %}</label>
					<textarea class="form-control" name="technical_interface_notes" placeholder="{% trans 'Descreva suposições implícitas, limitações conhecidas ou decisões técnicas relevantes.' %}" data-i18n-placeholder="technical_description_ph" rows="2" required maxlength="600"></textarea>

					<div id="interface-dynamic" class="mt-2">
						<div id="interface-rest" style="display:none;">
							<label class="form-label" data-i18n="base_endpoint">{% trans "Base endpoint" %}</label>
							<input class="form-control" name="endpoint" placeholder="{% trans 'Ex: https://api.empresa.com/v1' %}" data-i18n-placeholder="base_endpoint_ph">
							<label class="form-label" data-i18n="http_methods">{% trans "Métodos HTTP" %}</label>
							<div class="d-flex flex-wrap gap-2">
								<label class="form-check"><input class="form-check-input" type="checkbox" name="http_methods" value="GET"> GET</label>
								<label class="form-check"><input class="form-check-input" type="checkbox" name="http_methods" value="POST"> POST</label>
								<label class="form-check"><input class="form-check-input" type="checkbox" name="http_methods" value="PUT"> PUT</label>
								<label class="form-check"><input class="form-check-input" type="checkbox" name="http_methods" value="DELETE"> DELETE</label>
							</div>
							<label class="form-label" data-i18n="data_format">{% trans "Formato de dados" %}</label>
							<select class="form-select" name="formato_dados" id="interface-data-format">
								<option selected disabled value="" data-i18n="data_format">{% trans "Formato de dados" %}</option>
								<option value="JSON">JSON</option>
								<option value="XML">XML</option>
								<option value="CSV">CSV</option>
								<option value="Outro" data-i18n="other">{% trans "Outro" %}</option>
							</select>
							<input class="form-control" id="interface-data-format-other" name="formato_dados_outro" placeholder="{% trans 'Ex: Avro' %}" data-i18n-placeholder="data_format_other_ph" style="display:none;" maxlength="120">
							<label class="form-label" data-i18n="schema_optional">{% trans "Esquema (opcional)" %}</label>
							<textarea class="form-control" name="esquema" placeholder="{% trans 'Ex: Schema JSON v1 (link)' %}" data-i18n-placeholder="schema_ph" rows="2"></textarea>
							<label class="form-label" data-i18n="payload_example">{% trans "Exemplo de payload" %}</label>
							<textarea class="form-control" name="exemplo_dados" placeholder="{% trans 'Ex: {"id":123,"nome":"ACME"}' %}" data-i18n-placeholder="payload_example_ph" rows="2"></textarea>
						</div>

						<div id="interface-websocket" style="display:none;">
							<label class="form-label" data-i18n="connection_endpoint">{% trans "Connection endpoint" %}</label>
							<input class="form-control" name="connection_endpoint" placeholder="{% trans 'Ex: wss://ws.empresa.com/stream' %}" data-i18n-placeholder="connection_endpoint_ph">
							<label class="form-label" data-i18n="statefulness">{% trans "Statefulness" %}</label>
							<select class="form-select" name="statefulness">
								<option selected disabled value="" data-i18n="statefulness">{% trans "Statefulness" %}</option>
								<option value="stateful">Stateful</option>
								<option value="stateless">Stateless</option>
							</select>
							<label class="form-label" data-i18n="reconnection_policy">{% trans "Política de reconexão" %}</label>
							<input class="form-control" name="reconnection_policy" placeholder="{% trans 'Ex: retry exponencial 5x' %}" data-i18n-placeholder="reconnection_policy_ph">
						</div>

						<div id="interface-file" style="display:none;">
							<label class="form-label" data-i18n="file_type">{% trans "Tipo de arquivo" %}</label>
							<input class="form-control" name="file_type" placeholder="{% trans 'Ex: CSV' %}" data-i18n-placeholder="file_type_ph">
							<label class="form-label" data-i18n="transfer_protocol">{% trans "Protocolo de transferência" %}</label>
							<input class="form-control" name="transfer_protocol" placeholder="{% trans 'Ex: SFTP' %}" data-i18n-placeholder="transfer_protocol_ph">
							<label class="form-label" data-i18n="storage_location">{% trans "Local de armazenamento" %}</label>
							<input class="form-control" name="storage_location" placeholder="{% trans 'Ex: /data/inbound' %}" data-i18n-placeholder="storage_location_ph">
							<label class="form-label" data-i18n="processing_mode">{% trans "Modo de processamento" %}</label>
							<select class="form-select" name="processing_mode">
								<option selected disabled value="" data-i18n="processing_mode">{% trans "Modo de processamento" %}</option>
								<option value="batch">Batch</option>
								<option value="near-real-time">Near-real-time</option>
							</select>
						</div>

						<div id="interface-messaging" style="display:none;">
							<label class="form-label" data-i18n="broker">{% trans "Broker" %}</label>
							<input class="form-control" name="broker_type" placeholder="{% trans 'Ex: RabbitMQ' %}" data-i18n-placeholder="broker_ph">
							<label class="form-label" data-i18n="topic_or_queue">{% trans "Tópico ou fila" %}</label>
							<input class="form-control" name="topic_or_queue" placeholder="{% trans 'Ex: fila.crm.clientes' %}" data-i18n-placeholder="topic_or_queue_ph">
							<label class="form-label" data-i18n="message_format">{% trans "Formato da mensagem" %}</label>
							<input class="form-control" name="message_format" placeholder="{% trans 'Ex: JSON' %}" data-i18n-placeholder="message_format_ph">
							<label class="form-label" data-i18n="delivery_guarantees">{% trans "Garantias de entrega" %}</label>
							<input class="form-control" name="delivery_guarantees" placeholder="{% trans 'Ex: at-least-once' %}" data-i18n-placeholder="delivery_guarantees_ph">
						</div>

						<div id="interface-database" style="display:none;">
							<label class="form-label" data-i18n="db_access">{% trans "Detalhes de acesso ao banco" %}</label>
							<input class="form-control" name="db_access" placeholder="{% trans 'Ex: read-only replica' %}" data-i18n-placeholder="db_access_ph">
						</div>
					</div>

					<button class="btn btn-sm btn-primary w-100" id="interface-save-btn" data-i18n="save_interface">{% trans "Salvar interface" %}</button>
				</form>
							</div>
						</div>
					</div>

					<div class="accordion-item">
						<h2 class="accordion-header" id="headingIntegrations">
							<button class="accordion-button collapsed acc-missing" id="acc-integrations" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIntegrations" aria-expanded="false" aria-controls="collapseIntegrations">
								<span class="acc-label"><i class="bi bi-shuffle"></i> <span data-i18n="integration_styles">{% trans "Estilos de Integração" %}</span> <span class="req-pill" data-i18n="minimum_1">{% trans "mínimo 1" %}</span></span>
							</button>
						</h2>
						<div id="collapseIntegrations" class="accordion-collapse collapse" aria-labelledby="headingIntegrations" data-bs-parent="#dataAccordion">
							<div class="accordion-body">
								<div id="integrations-list" class="mb-3"></div>
								<form id="integration-form">
					<input type="hidden" id="integration-id" name="integration_id">
									<label class="form-label" data-i18n="source_system">{% trans "Sistema de origem" %}</label>
									<select class="form-select" name="sistema_origem_id" id="integration-origin-select" required></select>
									<label class="form-label" data-i18n="destination_system">{% trans "Sistema de destino" %}</label>
									<select class="form-select" name="sistema_destino_id" id="integration-dest-select" required></select>
									<label class="form-label" data-i18n="interfaces_used">{% trans "Interfaces usadas" %}</label>
									<select class="form-select multi-toggle" name="interfaces_usadas" id="integration-interfaces" multiple required></select>
									<div class="multi-hint" data-i18n="multi_hint">{% trans "Clique para selecionar múltiplos." %}</div>

									<label class="form-label" data-i18n="integration_style">{% trans "Estilo de integração" %}</label>
					<select class="form-select" name="estilo" id="integration-style" required>
										<option selected disabled value="" data-i18n="integration_style">{% trans "Estilo de integração" %}</option>
						<option value="Database Sharing">Database Sharing</option>
						<option value="Messaging">Messaging</option>
						<option value="RPC">RPC</option>
						<option value="File Transfer">File Transfer</option>
						<option value="Event-driven">Event-driven</option>
										<option value="Outro" data-i18n="other">{% trans "Outro" %}</option>
					</select>
									<input class="form-control" id="integration-style-other" name="estilo_outro" placeholder="{% trans 'Ex: Pub/Sub' %}" data-i18n-placeholder="integration_style_other_ph" style="display:none;" maxlength="80">

					<div id="style-db" style="display:none;">
						<label class="form-label" data-i18n="database_type">{% trans "Tipo de banco" %}</label>
						<input class="form-control" name="database_type" placeholder="{% trans 'Ex: PostgreSQL' %}" data-i18n-placeholder="database_type_ph">
						<label class="form-label" data-i18n="shared_tables_views">{% trans "Tabelas/visões compartilhadas" %}</label>
						<textarea class="form-control" name="shared_tables_or_views" placeholder="{% trans 'Ex: clientes, pedidos' %}" data-i18n-placeholder="shared_tables_views_ph" rows="2"></textarea>
						<label class="form-label" data-i18n="sync_mode">{% trans "Modo de sincronização" %}</label>
						<select class="form-select" name="sync_mode">
							<option selected disabled value="" data-i18n="sync_mode">{% trans "Modo de sincronização" %}</option>
							<option value="real-time">Real-time</option>
							<option value="batch">Batch</option>
						</select>
					</div>

					<div id="style-msg" style="display:none;">
						<label class="form-label" data-i18n="broker">{% trans "Broker" %}</label>
						<input class="form-control" name="broker" placeholder="{% trans 'Ex: RabbitMQ' %}" data-i18n-placeholder="broker_ph">
						<label class="form-label" data-i18n="topic_or_queue">{% trans "Tópico ou fila" %}</label>
						<input class="form-control" name="topic_or_queue" placeholder="{% trans 'Ex: fila.crm.clientes' %}" data-i18n-placeholder="topic_or_queue_ph">
						<label class="form-label" data-i18n="message_format">{% trans "Formato da mensagem" %}</label>
						<input class="form-control" name="message_format" placeholder="{% trans 'Ex: JSON' %}" data-i18n-placeholder="message_format_ph">
						<label class="form-label" data-i18n="processing_guarantees">{% trans "Garantias de processamento" %}</label>
						<input class="form-control" name="processing_guarantees" placeholder="{% trans 'Ex: at-least-once' %}" data-i18n-placeholder="processing_guarantees_ph">
					</div>

					<div id="style-rpc" style="display:none;">
						<label class="form-label" data-i18n="rpc_endpoint">{% trans "Endpoint RPC" %}</label>
						<input class="form-control" name="rpc_endpoint" placeholder="{% trans 'Ex: https://erp.local/rpc' %}" data-i18n-placeholder="rpc_endpoint_ph">
						<label class="form-label" data-i18n="rpc_mode">{% trans "Modo RPC" %}</label>
						<select class="form-select" name="rpc_mode">
							<option selected disabled value="" data-i18n="rpc_mode">{% trans "Modo RPC" %}</option>
							<option value="Síncrono" data-i18n="sync">{% trans "Síncrono" %}</option>
							<option value="Assíncrono" data-i18n="async">{% trans "Assíncrono" %}</option>
						</select>
					</div>

					<div id="style-file" style="display:none;">
						<label class="form-label" data-i18n="file_type">{% trans "Tipo de arquivo" %}</label>
						<input class="form-control" name="file_type" placeholder="{% trans 'Ex: CSV' %}" data-i18n-placeholder="file_type_ph">
						<label class="form-label" data-i18n="transfer_protocol">{% trans "Protocolo de transferência" %}</label>
						<input class="form-control" name="transfer_protocol" placeholder="{% trans 'Ex: SFTP' %}" data-i18n-placeholder="transfer_protocol_ph">
						<label class="form-label" data-i18n="storage_location">{% trans "Local de armazenamento" %}</label>
						<input class="form-control" name="storage_location" placeholder="{% trans 'Ex: /data/inbound' %}" data-i18n-placeholder="storage_location_ph">
						<label class="form-label" data-i18n="transformation">{% trans "Transformação" %}</label>
						<select class="form-select" name="transformation_type">
							<option selected disabled value="" data-i18n="transformation">{% trans "Transformação" %}</option>
							<option value="None">None</option>
							<option value="Structural mapping">Structural mapping</option>
							<option value="Semantic normalization">Semantic normalization</option>
							<option value="Enrichment">Enrichment</option>
							<option value="Outro" data-i18n="other">{% trans "Outro" %}</option>
						</select>
						<input class="form-control" id="transformation_type_other" name="transformation_type_other" placeholder="{% trans 'Ex: normalização de CNPJ' %}" data-i18n-placeholder="transformation_other_ph" style="display:none;" maxlength="80">
					</div>

					<label class="form-label" data-i18n="architectural_rationale">{% trans "Justificativa arquitetural" %}</label>
					<textarea class="form-control" name="architectural_rationale" placeholder="{% trans 'Por que este estilo de integração foi escolhido para este fluxo específico?' %}" data-i18n-placeholder="architectural_rationale_ph" rows="2" required maxlength="800"></textarea>

					<button class="btn btn-sm btn-primary w-100" id="integration-save-btn" data-i18n="save_integration">{% trans "Salvar integração" %}</button>
				</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel" data-i18n="example_title">Exemplo de cadastro (dados fictícios)</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<h6 class="mb-2">Sistemas</h6>
					<div class="card mb-2">
						<div class="card-body">
							<div class="fw-semibold">ERP Corporativo (SYS-8F3A2C)</div>
							<div class="text-muted small mb-2">Plataforma central de gestão financeira, compras e estoque.</div>
							<div class="row g-2 small">
								<div class="col-6"><strong>Tipo:</strong> ERP</div>
								<div class="col-6"><strong>Papel:</strong> Source (origem)</div>
								<div class="col-6"><strong>Protocolos:</strong> HTTPS, AMQP</div>
								<div class="col-6"><strong>Formatos:</strong> JSON, CSV</div>
								<div class="col-6"><strong>Autenticação:</strong> OAuth2</div>
								<div class="col-6"><strong>Versão:</strong> 12.4.1</div>
								<div class="col-12"><strong>Função no fluxo:</strong> Origem de pedidos, clientes, preços e faturas</div>
								<div class="col-12"><strong>Contato técnico:</strong> arq.erp@empresa.com.br</div>
								<div class="col-12"><strong>Observações técnicas:</strong> Janela de manutenção semanal às 23h; payloads com clientes acima de 10k registros são particionados.</div>
							</div>
						</div>
					</div>
					<div class="card">
						<div class="card-body">
							<div class="fw-semibold">CRM Comercial (SYS-9B7D1A)</div>
							<div class="text-muted small mb-2">Gestão de leads, pipeline e relacionamento com clientes.</div>
							<div class="row g-2 small">
								<div class="col-6"><strong>Tipo:</strong> CRM</div>
								<div class="col-6"><strong>Papel:</strong> Target (destino)</div>
								<div class="col-6"><strong>Protocolos:</strong> HTTPS</div>
								<div class="col-6"><strong>Formatos:</strong> JSON</div>
								<div class="col-6"><strong>Autenticação:</strong> API Key</div>
								<div class="col-6"><strong>Versão:</strong> 5.9.0</div>
								<div class="col-12"><strong>Função no fluxo:</strong> Atualização de leads, contas e oportunidades</div>
								<div class="col-12"><strong>Contato técnico:</strong> integração.crm@empresa.com.br</div>
								<div class="col-12"><strong>Observações técnicas:</strong> Rate limit 120 req/min; rejeita campos com valor nulo explícito.</div>
							</div>
						</div>
					</div>
				</div>

				<div class="mb-3">
					<h6 class="mb-2">Interfaces</h6>
					<div class="card mb-2">
						<div class="card-body">
							<div class="fw-semibold">API Clientes (INT-4C2E9B)</div>
							<div class="text-muted small mb-2">ERP Corporativo</div>
							<div class="row g-2 small">
								<div class="col-6"><strong>Tipo:</strong> REST API</div>
								<div class="col-6"><strong>Endpoint:</strong> https://erp.exemplo.local/api/v1/clientes</div>
								<div class="col-6"><strong>Métodos:</strong> GET, POST</div>
								<div class="col-6"><strong>Formato:</strong> JSON</div>
								<div class="col-6"><strong>Auth:</strong> OAuth2 (client_credentials)</div>
								<div class="col-6"><strong>Throttling:</strong> 100 req/s</div>
								<div class="col-12"><strong>Notas técnicas:</strong> Cliente ativo = status "A"; CPF pode vir mascarado em ambientes legados.</div>
							</div>
						</div>
					</div>
					<div class="card">
						<div class="card-body">
							<div class="fw-semibold">Fila de Eventos (INT-7A1F0D)</div>
							<div class="text-muted small mb-2">CRM Comercial</div>
							<div class="row g-2 small">
								<div class="col-6"><strong>Tipo:</strong> Messaging</div>
								<div class="col-6"><strong>Broker:</strong> RabbitMQ</div>
								<div class="col-6"><strong>Fila:</strong> crm.atualizacoes</div>
								<div class="col-6"><strong>Formato:</strong> JSON</div>
								<div class="col-12"><strong>Garantia:</strong> At-least-once, DLQ ativa após 5 tentativas</div>
								<div class="col-12"><strong>Notas técnicas:</strong> Mensagens >256KB são rejeitadas pelo broker.</div>
							</div>
						</div>
					</div>
				</div>

				<div class="mb-3">
					<h6 class="mb-2">Estilos de Integração</h6>
					<div class="card">
						<div class="card-body">
							<div class="fw-semibold">Messaging</div>
							<div class="row g-2 small">
								<div class="col-6"><strong>Origem:</strong> ERP Corporativo</div>
								<div class="col-6"><strong>Destino:</strong> CRM Comercial</div>
								<div class="col-12"><strong>Interfaces usadas:</strong> API Clientes, Fila de Eventos</div>
								<div class="col-6"><strong>Broker:</strong> RabbitMQ</div>
								<div class="col-6"><strong>Formato:</strong> JSON</div>
								<div class="col-6"><strong>Garantia:</strong> At-least-once</div>
								<div class="col-6"><strong>Modo:</strong> Assíncrono</div>
								<div class="col-12"><strong>Transformação:</strong> Normalização semântica (padronização de CNPJ e timezone)</div>
								<div class="col-12"><strong>Justificativa:</strong> Mensageria reduz acoplamento, suporta picos de carga e permite reprocessamento controlado.</div>
							</div>
						</div>
					</div>
				</div>

				<p class="text-muted mb-0" data-i18n="example_footer">Exemplo fictício para orientar preenchimento com base em cenários reais.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="close">Fechar</button>
			</div>
		</div>
	</div>
</div>

{{ systems|json_script:"systems-data" }}
{{ interfaces|json_script:"interfaces-data" }}
{{ integrations|json_script:"integrations-data" }}
{{ messages|json_script:"messages-data" }}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
	const projectId = '{{ project.id }}';
	const csrfToken = '{{ csrf_token }}';
	function getCsrfToken() {
		if (csrfToken && csrfToken !== 'NOTPROVIDED') return csrfToken;
		const match = document.cookie.match(/csrftoken=([^;]+)/);
		return match ? decodeURIComponent(match[1]) : '';
	}

	let systems = JSON.parse(document.getElementById('systems-data').textContent || '[]');
	let interfaces = JSON.parse(document.getElementById('interfaces-data').textContent || '[]');
	let integrations = JSON.parse(document.getElementById('integrations-data').textContent || '[]');
	const messages = JSON.parse(document.getElementById('messages-data').textContent || '[]');

	const chatArea = document.getElementById('chat-area');
	const promptBox = document.getElementById('prompt-box');
	const statusBadge = document.getElementById('status-badge');
	const errorMsg = document.getElementById('error-msg');
	const sendBtn = document.getElementById('send-btn');
	const jumpWrap = document.querySelector('.jump-consult');
	const jumpBtn = document.getElementById('jump-consult');
	const analysisCopyBtn = document.getElementById('analysis-copy');
	const analysisDownloadBtn = document.getElementById('analysis-download');
	let isStreaming = false;
	let promptRaw = '';

	const translations = {
		pt: {
			conversations: 'Conversas',
			new_chat: 'Nova conversa',
			back_home: 'Voltar ao início',
			no_conversations: 'Nenhuma conversa criada.',
			status_new: 'Status: Novo',
			status_ready: 'Status: Pronto',
			status_generating: 'Status: Gerando...',
			top_message: 'Registre sistemas, interfaces e estilos de integração para iniciar a análise.',
			scroll_down: 'Descer a página',
			scroll_up: 'Ir para Topo',
			analysis: 'Análise Técnica',
			clear_screen: 'Limpar tela',
			generated_analysis: 'Análise gerada',
			copy: 'Copiar',
			download: 'Baixar',
			no_analysis: 'Nenhuma análise gerada ainda. Clique em <strong>Análise Técnica</strong> para começar.',
			prompt_used: 'Prompt utilizado',
			prompt_meta: 'Somente leitura • Para fins de transparência das técnicas aplicadas.',
			expand: 'Expandir',
			reduce: 'Reduzir',
			prompt_placeholder: '(O prompt aparecerá aqui após a consulta.)',
			session_expired: 'Sessão expirada. Recarregue a página.',
			load_chats_error: 'Não foi possível carregar as conversas.',
			no_systems: 'Nenhum sistema cadastrado.',
			no_interfaces: 'Nenhuma interface cadastrada.',
			no_integrations: 'Nenhuma integração cadastrada.',
			edit: 'Editar',
			delete: 'Excluir',
			prompt_copied: 'Copiado',
			analysis_none_copy: 'Nenhuma análise para copiar.',
			analysis_none_download: 'Nenhuma análise para baixar.',
			registration: 'Cadastro',
			example: 'Exemplo',
			section_identity: 'Identidade',
			system_id: 'ID do sistema',
			system_id_ph: 'Ex: SYS-ERP-01',
			system_name: 'Nome do sistema',
			system_name_ph: 'Ex: ERP Corporativo',
			system_type: 'Tipo de sistema',
			other_describe: 'Outro (descrever)',
			system_type_other_ph: 'Ex: Mainframe legado',
			description: 'Descrição',
			description_ph: 'Breve descrição',
			section_arch_role: 'Papel arquitetural',
			flow_role: 'Papel no fluxo',
			role_source: 'Origem (Source)',
			role_target: 'Destino (Target)',
			role_both: 'Ambos (Both)',
			primary_function: 'Função principal no fluxo',
			primary_function_ph: 'Ex: Origem de pedidos e clientes',
			section_tech_capabilities: 'Capacidades técnicas',
			supported_protocols: 'Protocolos suportados',
			multi_hint: 'Clique para selecionar múltiplos.',
			protocol_other_ph: 'Ex: MQTT',
			supported_data_formats: 'Formatos de dados suportados',
			data_format_other_ph: 'Ex: Parquet',
			auth_methods: 'Métodos de autenticação',
			auth_other_ph: 'Ex: SAML',
			optional_metadata: 'Metadados opcionais',
			version: 'Versão',
			version_ph: 'Ex: 12.4.1',
			technical_contact: 'Contato técnico',
			technical_contact_ph: 'Ex: arq.erp@empresa.com.br',
			technical_notes: 'Observações técnicas',
			technical_notes_ph: 'Observações técnicas (se houver exceções)',
			save_system: 'Salvar sistema',
			systems: 'Sistemas',
			minimum_2: 'mínimo 2',
			interfaces: 'Interfaces',
			minimum_1: 'mínimo 1',
			common_fields: 'Campos comuns',
			interface_id: 'ID da interface',
			interface_id_ph: 'Ex: INT-CLIENTES-01',
			interface_name: 'Nome da interface',
			interface_name_ph: 'Ex: API Clientes',
			related_system: 'Sistema relacionado',
			interface_type: 'Tipo de interface',
			other_custom: 'Outro (custom)',
			interface_type_other_ph: 'Ex: gRPC',
			supported_operations: 'Operações suportadas',
			supported_operations_ph: 'Ex: GET /clientes, POST /clientes',
			authentication: 'Autenticação',
			none: 'Nenhuma',
			other: 'Outro',
			throttling: 'Throttling',
			throttling_value_ph: 'Throttling (valor)',
			throttling_unit_ph: 'Unidade (req/s, msg/min)',
			technical_description: 'Descrição técnica',
			technical_description_ph: 'Descreva suposições implícitas, limitações conhecidas ou decisões técnicas relevantes.',
			base_endpoint: 'Base endpoint',
			base_endpoint_ph: 'Ex: https://api.empresa.com/v1',
			http_methods: 'Métodos HTTP',
			data_format: 'Formato de dados',
			schema_optional: 'Esquema (opcional)',
			schema_ph: 'Ex: Schema JSON v1 (link)',
			payload_example: 'Exemplo de payload',
			payload_example_ph: 'Ex: {"id":123,"nome":"ACME"}',
			connection_endpoint: 'Connection endpoint',
			connection_endpoint_ph: 'Ex: wss://ws.empresa.com/stream',
			statefulness: 'Statefulness',
			reconnection_policy: 'Política de reconexão',
			reconnection_policy_ph: 'Ex: retry exponencial 5x',
			file_type: 'Tipo de arquivo',
			file_type_ph: 'Ex: CSV',
			transfer_protocol: 'Protocolo de transferência',
			transfer_protocol_ph: 'Ex: SFTP',
			storage_location: 'Local de armazenamento',
			storage_location_ph: 'Ex: /data/inbound',
			processing_mode: 'Modo de processamento',
			broker: 'Broker',
			broker_ph: 'Ex: RabbitMQ',
			topic_or_queue: 'Tópico ou fila',
			topic_or_queue_ph: 'Ex: fila.crm.clientes',
			message_format: 'Formato da mensagem',
			message_format_ph: 'Ex: JSON',
			delivery_guarantees: 'Garantias de entrega',
			delivery_guarantees_ph: 'Ex: at-least-once',
			db_access: 'Detalhes de acesso ao banco',
			db_access_ph: 'Ex: read-only replica',
			save_interface: 'Salvar interface',
			integration_styles: 'Estilos de Integração',
			source_system: 'Sistema de origem',
			destination_system: 'Sistema de destino',
			interfaces_used: 'Interfaces usadas',
			integration_style: 'Estilo de integração',
			integration_style_other_ph: 'Ex: Pub/Sub',
			database_type: 'Tipo de banco',
			database_type_ph: 'Ex: PostgreSQL',
			shared_tables_views: 'Tabelas/visões compartilhadas',
			shared_tables_views_ph: 'Ex: clientes, pedidos',
			sync_mode: 'Modo de sincronização',
			processing_guarantees: 'Garantias de processamento',
			processing_guarantees_ph: 'Ex: at-least-once',
			rpc_endpoint: 'Endpoint RPC',
			rpc_endpoint_ph: 'Ex: https://erp.local/rpc',
			rpc_mode: 'Modo RPC',
			sync: 'Síncrono',
			async: 'Assíncrono',
			transformation: 'Transformação',
			transformation_other_ph: 'Ex: normalização de CNPJ',
			architectural_rationale: 'Justificativa arquitetural',
			architectural_rationale_ph: 'Por que este estilo de integração foi escolhido para este fluxo específico?',
			save_integration: 'Salvar integração',
			example_title: 'Exemplo de cadastro (dados fictícios)',
			example_footer: 'Exemplo fictício para orientar preenchimento com base em cenários reais.',
			close: 'Fechar',
		},
		en: {
			conversations: 'Conversations',
			new_chat: 'New chat',
			back_home: 'Back to home',
			no_conversations: 'No conversations created.',
			status_new: 'Status: New',
			status_ready: 'Status: Ready',
			status_generating: 'Status: Generating...',
			top_message: 'Register systems, interfaces, and integration styles to start the analysis.',
			scroll_down: 'Scroll down',
			scroll_up: 'Back to top',
			analysis: 'Technical Analysis',
			clear_screen: 'Clear screen',
			generated_analysis: 'Generated analysis',
			copy: 'Copy',
			download: 'Download',
			no_analysis: 'No analysis generated yet. Click <strong>Technical Analysis</strong> to start.',
			prompt_used: 'Prompt used',
			prompt_meta: 'Read-only • For transparency of applied techniques.',
			expand: 'Expand',
			reduce: 'Collapse',
			prompt_placeholder: '(The prompt will appear here after the request.)',
			session_expired: 'Session expired. Reload the page.',
			load_chats_error: 'Could not load conversations.',
			no_systems: 'No systems registered.',
			no_interfaces: 'No interfaces registered.',
			no_integrations: 'No integrations registered.',
			edit: 'Edit',
			delete: 'Delete',
			prompt_copied: 'Copied',
			analysis_none_copy: 'No analysis to copy.',
			analysis_none_download: 'No analysis to download.',
			registration: 'Registration',
			example: 'Example',
			section_identity: 'Identity',
			system_id: 'System ID',
			system_id_ph: 'Ex: SYS-ERP-01',
			system_name: 'System name',
			system_name_ph: 'Ex: Corporate ERP',
			system_type: 'System type',
			other_describe: 'Other (describe)',
			system_type_other_ph: 'Ex: Legacy mainframe',
			description: 'Description',
			description_ph: 'Short description',
			section_arch_role: 'Architectural role',
			flow_role: 'Role in the flow',
			role_source: 'Source',
			role_target: 'Target',
			role_both: 'Both',
			primary_function: 'Primary function in the flow',
			primary_function_ph: 'Ex: Source of orders and customers',
			section_tech_capabilities: 'Technical capabilities',
			supported_protocols: 'Supported protocols',
			multi_hint: 'Click to select multiple.',
			protocol_other_ph: 'Ex: MQTT',
			supported_data_formats: 'Supported data formats',
			data_format_other_ph: 'Ex: Parquet',
			auth_methods: 'Authentication methods',
			auth_other_ph: 'Ex: SAML',
			optional_metadata: 'Optional metadata',
			version: 'Version',
			version_ph: 'Ex: 12.4.1',
			technical_contact: 'Technical contact',
			technical_contact_ph: 'Ex: arch.erp@company.com',
			technical_notes: 'Technical notes',
			technical_notes_ph: 'Technical notes (if there are exceptions)',
			save_system: 'Save system',
			systems: 'Systems',
			minimum_2: 'minimum 2',
			interfaces: 'Interfaces',
			minimum_1: 'minimum 1',
			common_fields: 'Common fields',
			interface_id: 'Interface ID',
			interface_id_ph: 'Ex: INT-CUSTOMERS-01',
			interface_name: 'Interface name',
			interface_name_ph: 'Ex: Customers API',
			related_system: 'Related system',
			interface_type: 'Interface type',
			other_custom: 'Other (custom)',
			interface_type_other_ph: 'Ex: gRPC',
			supported_operations: 'Supported operations',
			supported_operations_ph: 'Ex: GET /customers, POST /customers',
			authentication: 'Authentication',
			none: 'None',
			other: 'Other',
			throttling: 'Throttling',
			throttling_value_ph: 'Throttling (value)',
			throttling_unit_ph: 'Unit (req/s, msg/min)',
			technical_description: 'Technical description',
			technical_description_ph: 'Describe implicit assumptions, known limitations, or relevant technical decisions.',
			base_endpoint: 'Base endpoint',
			base_endpoint_ph: 'Ex: https://api.company.com/v1',
			http_methods: 'HTTP methods',
			data_format: 'Data format',
			schema_optional: 'Schema (optional)',
			schema_ph: 'Ex: JSON Schema v1 (link)',
			payload_example: 'Payload example',
			payload_example_ph: 'Ex: {"id":123,"name":"ACME"}',
			connection_endpoint: 'Connection endpoint',
			connection_endpoint_ph: 'Ex: wss://ws.company.com/stream',
			statefulness: 'Statefulness',
			reconnection_policy: 'Reconnection policy',
			reconnection_policy_ph: 'Ex: exponential retry 5x',
			file_type: 'File type',
			file_type_ph: 'Ex: CSV',
			transfer_protocol: 'Transfer protocol',
			transfer_protocol_ph: 'Ex: SFTP',
			storage_location: 'Storage location',
			storage_location_ph: 'Ex: /data/inbound',
			processing_mode: 'Processing mode',
			broker: 'Broker',
			broker_ph: 'Ex: RabbitMQ',
			topic_or_queue: 'Topic or queue',
			topic_or_queue_ph: 'Ex: queue.crm.customers',
			message_format: 'Message format',
			message_format_ph: 'Ex: JSON',
			delivery_guarantees: 'Delivery guarantees',
			delivery_guarantees_ph: 'Ex: at-least-once',
			db_access: 'Database access details',
			db_access_ph: 'Ex: read-only replica',
			save_interface: 'Save interface',
			integration_styles: 'Integration styles',
			source_system: 'Source system',
			destination_system: 'Destination system',
			interfaces_used: 'Interfaces used',
			integration_style: 'Integration style',
			integration_style_other_ph: 'Ex: Pub/Sub',
			database_type: 'Database type',
			database_type_ph: 'Ex: PostgreSQL',
			shared_tables_views: 'Shared tables/views',
			shared_tables_views_ph: 'Ex: customers, orders',
			sync_mode: 'Sync mode',
			processing_guarantees: 'Processing guarantees',
			processing_guarantees_ph: 'Ex: at-least-once',
			rpc_endpoint: 'RPC endpoint',
			rpc_endpoint_ph: 'Ex: https://erp.local/rpc',
			rpc_mode: 'RPC mode',
			sync: 'Synchronous',
			async: 'Asynchronous',
			transformation: 'Transformation',
			transformation_other_ph: 'Ex: CNPJ normalization',
			architectural_rationale: 'Architectural rationale',
			architectural_rationale_ph: 'Why was this integration style chosen for this specific flow?',
			save_integration: 'Save integration',
			example_title: 'Registration example (fictional data)',
			example_footer: 'Fictional example to guide completion based on real scenarios.',
			close: 'Close',
		}
	};

	let currentLang = localStorage.getItem('lang') || 'pt';
	const t = (key) => (translations[currentLang] && translations[currentLang][key]) || translations.pt[key] || key;

	function applyTranslations() {
		document.documentElement.lang = currentLang === 'pt' ? 'pt-br' : 'en';
		document.querySelectorAll('[data-i18n]').forEach(el => {
			if (el.id === 'prompt-box' && promptRaw && String(promptRaw).trim().length > 0) {
				return;
			}
			el.textContent = t(el.dataset.i18n);
		});
		document.querySelectorAll('[data-i18n-html]').forEach(el => {
			el.innerHTML = t(el.dataset.i18nHtml);
		});
		document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
			el.placeholder = t(el.dataset.i18nPlaceholder);
		});
	}

	function setLanguage(lang) {
		currentLang = lang === 'en' ? 'en' : 'pt';
		localStorage.setItem('lang', currentLang);
		applyTranslations();
		renderMessages();
		renderList();
		updateStatusBadge(isStreaming);
		updateJumpButtonState();
		if (promptToggle) {
			promptToggle.innerHTML = promptExpanded
				? `<i class="bi bi-arrows-angle-contract me-1"></i>${t('reduce')}`
				: `<i class="bi bi-arrows-angle-expand me-1"></i>${t('expand')}`;
		}
	}

	const renderMarkdown = (text) => {
		if (window.marked && typeof window.marked.parse === 'function') {
			return window.marked.parse(text || '');
		}
		return text || '';
	};

	function updateJumpVisibility() {
		if (!jumpWrap) return;
		const hasAssistant = messages.some(m => m.role === 'assistant' && String(m.content || '').trim().length > 0);
		jumpWrap.style.display = hasAssistant ? 'flex' : 'none';
	}

	function updateJumpButtonState() {
		if (!jumpBtn) return;
		const nearTop = window.scrollY < 20;
		const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.scrollHeight - 20);
		if (nearBottom && !nearTop) {
			jumpBtn.dataset.jump = 'up';
			jumpBtn.innerHTML = `<i class="bi bi-arrow-up-circle me-1"></i>${t('scroll_up')}`;
		} else {
			jumpBtn.dataset.jump = 'down';
			jumpBtn.innerHTML = `<i class="bi bi-arrow-down-circle me-1"></i>${t('scroll_down')}`;
		}
	}

	function hasAnalysis() {
		return messages.some(m => m.role === 'assistant' && String(m.content || '').trim().length > 0);
	}

	function updateStatusBadge(isStreaming = false) {
		if (!statusBadge) return;
		if (isStreaming) {
			statusBadge.className = 'status-pill is-running';
			statusBadge.innerHTML = `<i class="bi bi-lightning-charge"></i><span>${t('status_generating')}</span>`;
			return;
		}

		if (hasAnalysis()) {
			statusBadge.className = 'status-pill is-ready';
			statusBadge.innerHTML = `<i class="bi bi-activity"></i><span>${t('status_ready')}</span>`;
		} else {
			statusBadge.className = 'status-pill is-new';
			statusBadge.innerHTML = `<i class="bi bi-stars"></i><span>${t('status_new')}</span>`;
		}
	}

	function renderMessages() {
		if (!chatArea) return;
		chatArea.innerHTML = '';
		messages.forEach(m => {
			const div = document.createElement('div');
			div.className = 'msg ' + (m.role === 'user' ? 'user' : 'assistant');
			div.innerHTML = m.role === 'assistant' ? renderMarkdown(m.content) : (m.content || '');
			chatArea.appendChild(div);
		});

		const emptyState = document.getElementById('empty-state');
		if (emptyState) {
			emptyState.style.display = messages.length === 0 ? 'block' : 'none';
		}
		updateJumpVisibility();
		updateJumpButtonState();
		updateStatusBadge(isStreaming);
		if (isStreaming) {
			scrollToChatArea();
		}
	}

	function getLatestPromptUsed() {
		for (let i = messages.length - 1; i >= 0; i -= 1) {
			const m = messages[i];
			if (m.prompt_used && String(m.prompt_used).trim().length > 0) {
				return m.prompt_used;
			}
		}
		return '';
	}

	function scrollToChatArea() {
		if (!chatArea) return;
		const lastMsg = chatArea.querySelector('.msg:last-child');
		if (lastMsg) {
			lastMsg.scrollIntoView({ behavior: 'smooth', block: 'end' });
		} else {
			chatArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
		}
	}

	function getLatestAnalysisText() {
		for (let i = messages.length - 1; i >= 0; i -= 1) {
			const m = messages[i];
			if (m.role === 'assistant' && String(m.content || '').trim().length > 0) {
				return m.content;
			}
		}
		return '';
	}

		function fallbackCopyText(text) {
		const textarea = document.createElement('textarea');
		textarea.value = text;
		textarea.style.position = 'fixed';
		textarea.style.opacity = '0';
		document.body.appendChild(textarea);
		textarea.focus();
		textarea.select();
		try { document.execCommand('copy'); } catch (e) {}
		document.body.removeChild(textarea);
	}

		function buildAnalysisHtml(markdown) {
				const bodyHtml = renderMarkdown(markdown || '');
				return `<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Análise Técnica</title>
	<style>
		body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color:#0f172a; background:#f8fafc; margin:0; padding:24px; }
		.doc { max-width: 900px; margin: 0 auto; background:#fff; padding:28px; border-radius:14px; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08); }
		h1, h2, h3 { color:#0b3954; margin-top: 1.4em; }
		h1 { font-size: 1.6rem; margin-top: 0; }
		h2 { font-size: 1.25rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; }
		h3 { font-size: 1.05rem; }
		p { line-height: 1.6; }
		ul { padding-left: 1.2rem; }
		li { margin: 0.4rem 0; }
		strong { color:#0f172a; }
		code, pre { background:#0b1220; color:#e2e8f0; border-radius:8px; }
		pre { padding:12px; overflow:auto; }
		blockquote { border-left: 4px solid #94a3b8; padding-left: 12px; color:#475569; }
	</style>
</head>
<body>
	<div class="doc">${bodyHtml}</div>
</body>
</html>`;
		}

	if (analysisCopyBtn) {
		analysisCopyBtn.addEventListener('click', async () => {
			const text = getLatestAnalysisText();
			if (!text) {
				alert(t('analysis_none_copy'));
				return;
			}
			const html = renderMarkdown(text);
			try {
				if (navigator.clipboard?.write) {
					const item = new ClipboardItem({
						'text/html': new Blob([html], { type: 'text/html' }),
						'text/plain': new Blob([text], { type: 'text/plain' })
					});
					await navigator.clipboard.write([item]);
				} else if (navigator.clipboard?.writeText) {
					await navigator.clipboard.writeText(text);
				} else {
					fallbackCopyText(text);
				}
			} catch (e) {
				fallbackCopyText(text);
			}
		});
	}

	if (analysisDownloadBtn) {
		analysisDownloadBtn.addEventListener('click', () => {
			const text = getLatestAnalysisText();
			if (!text) {
				alert(t('analysis_none_download'));
				return;
			}
			const html = buildAnalysisHtml(text);
			const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `analise-tecnica-${projectId}.html`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		});
	}

	function renderList() {
		const systemsList = document.getElementById('systems-list');
		const interfacesList = document.getElementById('interfaces-list');
		const integrationsList = document.getElementById('integrations-list');

		systemsList.classList.add('data-list');
		interfacesList.classList.add('data-list');
		integrationsList.classList.add('data-list');

		const systemMap = new Map(systems.map(s => [String(s.id), s.nome]));
		const getSystemName = (id) => systemMap.get(String(id)) || 'Sistema';

		systemsList.innerHTML = systems.length ? systems.map(s => `
			<div class="data-item system-item" data-id="${s.id}">
				<div class="data-item-content">
					<div class="data-item-title">${s.nome}</div>
					${s.tipo ? `<div class="data-item-sub">${s.tipo}</div>` : ''}
					${s.versao ? `<div class="data-item-meta">Versão ${s.versao}</div>` : ''}
				</div>
				<div class="data-item-actions">
					<button type="button" class="edit-system" data-id="${s.id}" title="${t('edit')}"><i class="bi bi-pencil"></i></button>
					<button type="button" class="delete-system delete-btn" data-id="${s.id}" title="${t('delete')}"><i class="bi bi-trash"></i></button>
				</div>
			</div>
		`).join('') : `<div class="data-empty">${t('no_systems')}</div>`;

		interfacesList.innerHTML = interfaces.length ? interfaces.map(i => `
			<div class="data-item interface-item" data-id="${i.id}">
				<div class="data-item-content">
					<div class="data-item-title">${i.nome}</div>
					<div class="data-item-sub">${i.tipo || 'Interface'} • ${getSystemName(i.sistema_id)}</div>
					${i.formato_dados ? `<div class="data-item-meta">Formato: ${i.formato_dados}</div>` : ''}
				</div>
				<div class="data-item-actions">
					<button type="button" class="edit-interface" data-id="${i.id}" title="${t('edit')}"><i class="bi bi-pencil"></i></button>
					<button type="button" class="delete-interface delete-btn" data-id="${i.id}" title="${t('delete')}"><i class="bi bi-trash"></i></button>
				</div>
			</div>
		`).join('') : `<div class="data-empty">${t('no_interfaces')}</div>`;

		integrationsList.innerHTML = integrations.length ? integrations.map(i => `
			<div class="data-item integration-item" data-id="${i.id}">
				<div class="data-item-content">
					<div class="data-item-title">${i.estilo}</div>
					<div class="data-item-sub">${getSystemName(i.sistema_origem_id)} → ${getSystemName(i.sistema_destino_id)}</div>
					${i.detalhes ? `<div class="data-item-meta">Detalhes registrados</div>` : ''}
				</div>
				<div class="data-item-actions">
					<button type="button" class="edit-integration" data-id="${i.id}" title="${t('edit')}"><i class="bi bi-pencil"></i></button>
					<button type="button" class="delete-integration delete-btn" data-id="${i.id}" title="${t('delete')}"><i class="bi bi-trash"></i></button>
				</div>
			</div>
		`).join('') : `<div class="data-empty">${t('no_integrations')}</div>`;

		const systemSelects = [
			document.getElementById('interface-system-select'),
			document.getElementById('integration-origin-select'),
			document.getElementById('integration-dest-select')
		];

		systemSelects.forEach(select => {
			select.innerHTML = systems.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
		});

		const interfaceSelect = document.getElementById('integration-interfaces');
		if (interfaceSelect) {
			interfaceSelect.innerHTML = interfaces.map(i => `<option value="${i.id}">${i.nome}</option>`).join('');
		}
	}

	async function refreshLists() {
		const [sysResp, intResp, integResp] = await Promise.all([
			fetch(`/api/${projectId}/systems/`, { credentials: 'same-origin' }),
			fetch(`/api/${projectId}/interfaces/`, { credentials: 'same-origin' }),
			fetch(`/api/${projectId}/integrations/`, { credentials: 'same-origin' }),
		]);

		const safeJson = async (resp) => {
			const contentType = resp.headers.get('content-type') || '';
			if (!resp.ok || !contentType.includes('application/json')) {
				return {};
			}
			return resp.json();
		};

		const sysData = await safeJson(sysResp);
		const intData = await safeJson(intResp);
		const integData = await safeJson(integResp);

		systems = sysData.systems || [];
		interfaces = intData.interfaces || [];
		integrations = integData.integrations || [];
		renderList();
		updateConsultarState();
	}

	function updateConsultarState() {
		const enabled = systems.length >= 2 && interfaces.length >= 1 && integrations.length >= 1;
		sendBtn.disabled = !enabled;
		sendBtn.classList.toggle('disabled', !enabled);

		const accSystems = document.getElementById('acc-systems');
		const accInterfaces = document.getElementById('acc-interfaces');
		const accIntegrations = document.getElementById('acc-integrations');

		if (accSystems) {
			accSystems.classList.toggle('acc-ok', systems.length >= 2);
			accSystems.classList.toggle('acc-missing', systems.length < 2);
		}
		if (accInterfaces) {
			accInterfaces.classList.toggle('acc-ok', interfaces.length >= 1);
			accInterfaces.classList.toggle('acc-missing', interfaces.length < 1);
		}
		if (accIntegrations) {
			accIntegrations.classList.toggle('acc-ok', integrations.length >= 1);
			accIntegrations.classList.toggle('acc-missing', integrations.length < 1);
		}
	}

	function setStreamingState(streaming) {
		isStreaming = !!streaming;
		document.getElementById('send-btn').disabled = isStreaming;
		document.querySelectorAll('input,textarea,select,button').forEach(el => {
			if (el.id !== 'send-btn' && el.id !== 'clear-btn') {
				el.disabled = isStreaming;
			}
		});
		updateStatusBadge(isStreaming);
	}

	function formToJSON(form, multiFields = []) {
		const formData = new FormData(form);
		const data = {};
		for (const [key, value] of formData.entries()) {
			if (multiFields.includes(key)) {
				data[key] = formData.getAll(key);
			} else {
				data[key] = value;
			}
		}
		return data;
	}

	const toggleOtherField = (selectEl, inputEl) => {
		if (!selectEl || !inputEl) return;
		const selectedValues = Array.from(selectEl.selectedOptions || []).map(o => o.value);
		const isOther = selectedValues.includes('Outro') || selectEl.value === 'Outro';
		inputEl.style.display = isOther ? 'block' : 'none';
	};

	document.querySelectorAll('select[multiple].multi-toggle').forEach(select => {
		select.addEventListener('mousedown', (e) => {
			if (e.target.tagName === 'OPTION') {
				e.preventDefault();
				e.target.selected = !e.target.selected;
				select.dispatchEvent(new Event('change'));
			}
		});
	});

	// System handlers
	const systemType = document.getElementById('system-type');
	const systemTypeOther = document.getElementById('system-type-other');
	if (systemType) {
		systemType.addEventListener('change', () => toggleOtherField(systemType, systemTypeOther));
	}
	const protocolosSelect = document.getElementById('protocolos_suportados');
	const protocolosOutro = document.getElementById('protocolos_suportados_outro');
	if (protocolosSelect) {
		protocolosSelect.addEventListener('change', () => toggleOtherField(protocolosSelect, protocolosOutro));
	}
	const formatosSelect = document.getElementById('capacidades_dados');
	const formatosOutro = document.getElementById('capacidades_dados_outro');
	if (formatosSelect) {
		formatosSelect.addEventListener('change', () => toggleOtherField(formatosSelect, formatosOutro));
	}
	const authSelect = document.getElementById('requisitos_autenticacao');
	const authOutro = document.getElementById('requisitos_autenticacao_outro');
	if (authSelect) {
		authSelect.addEventListener('change', () => toggleOtherField(authSelect, authOutro));
	}
	const systemAdvancedToggle = document.getElementById('system-advanced-toggle');
	const systemAdvanced = document.getElementById('system-advanced');
	if (systemAdvancedToggle && systemAdvanced) {
		systemAdvancedToggle.addEventListener('click', () => {
			systemAdvanced.style.display = systemAdvanced.style.display === 'none' ? 'block' : 'none';
		});
	}

	// Interface type blocks
	const interfaceType = document.getElementById('interface-type');
	const interfaceTypeOther = document.getElementById('interface-type-other');
	const interfaceAuthSelect = document.getElementById('autenticacao');
	const interfaceAuthOther = document.getElementById('autenticacao_outro');
	if (interfaceAuthSelect) {
		interfaceAuthSelect.addEventListener('change', () => toggleOtherField(interfaceAuthSelect, interfaceAuthOther));
	}
	const interfaceDataFormat = document.getElementById('interface-data-format');
	const interfaceDataFormatOther = document.getElementById('interface-data-format-other');
	if (interfaceDataFormat) {
		interfaceDataFormat.addEventListener('change', () => toggleOtherField(interfaceDataFormat, interfaceDataFormatOther));
	}
	const interfaceBlocks = {
		'REST API': document.getElementById('interface-rest'),
		'SOAP': document.getElementById('interface-rest'),
		'WebSocket': document.getElementById('interface-websocket'),
		'Messaging': document.getElementById('interface-messaging'),
		'File-based': document.getElementById('interface-file'),
		'Database Access': document.getElementById('interface-database'),
	};

	const getHttpMethodsFromText = (text) => {
		if (!text) return [];
		const tokens = text.toUpperCase().split(/[^A-Z]/).filter(Boolean);
		const allowed = ['GET', 'POST', 'PUT', 'DELETE'];
		return allowed.filter(m => tokens.includes(m));
	};

	const isMethodsOnly = (text) => {
		if (!text) return true;
		const tokens = text.toUpperCase().split(/[^A-Z]/).filter(Boolean);
		if (!tokens.length) return true;
		return tokens.every(t => ['GET', 'POST', 'PUT', 'DELETE'].includes(t));
	};

	const syncHttpMethodsFromOperations = () => {
		const opField = document.querySelector('input[name="operacoes_suportadas"]');
		if (!opField) return;
		const methods = getHttpMethodsFromText(opField.value);
		if (!methods.length) return;
		document.querySelectorAll('input[name="http_methods"]').forEach(cb => {
			cb.checked = methods.includes(cb.value);
		});
	};

	const syncOperationsFromHttpMethods = () => {
		const opField = document.querySelector('input[name="operacoes_suportadas"]');
		if (!opField) return;
		if (!isMethodsOnly(opField.value)) return;
		const selected = Array.from(document.querySelectorAll('input[name="http_methods"]'))
			.filter(cb => cb.checked)
			.map(cb => cb.value);
		opField.value = selected.join(', ');
	};
	if (interfaceType) {
		interfaceType.addEventListener('change', () => {
			Object.values(interfaceBlocks).forEach(el => { if (el) el.style.display = 'none'; });
			const block = interfaceBlocks[interfaceType.value];
			if (block) block.style.display = 'block';
			toggleOtherField(interfaceType, interfaceTypeOther);
			if (interfaceType.value === 'REST API' || interfaceType.value === 'SOAP') {
				syncHttpMethodsFromOperations();
			}
		});
	}

	document.querySelectorAll('input[name="http_methods"]').forEach(cb => {
		cb.addEventListener('change', syncOperationsFromHttpMethods);
	});

	// Integration style conditional blocks
	const integrationStyle = document.getElementById('integration-style');
	const integrationStyleOther = document.getElementById('integration-style-other');
	const styleBlocks = {
		'Database Sharing': document.getElementById('style-db'),
		'Messaging': document.getElementById('style-msg'),
		'RPC': document.getElementById('style-rpc'),
		'File Transfer': document.getElementById('style-file'),
	};
	if (integrationStyle) {
		integrationStyle.addEventListener('change', () => {
			Object.values(styleBlocks).forEach(el => { if (el) el.style.display = 'none'; });
			const block = styleBlocks[integrationStyle.value];
			if (block) block.style.display = 'block';
			toggleOtherField(integrationStyle, integrationStyleOther);
		});
	}

	const transformationType = document.querySelector('select[name="transformation_type"]');
	const transformationOther = document.getElementById('transformation_type_other');
	if (transformationType) {
		transformationType.addEventListener('change', () => toggleOtherField(transformationType, transformationOther));
	}

	let editingSystemId = null;
	let editingInterfaceId = null;
	let editingIntegrationId = null;

	function clearSystemForm() {
		const form = document.getElementById('system-form');
		if (!form) return;
		form.reset();
		editingSystemId = null;
		const saveBtn = document.getElementById('system-save-btn');
		if (saveBtn) saveBtn.textContent = 'Salvar sistema';
		const systemTypeSelect = document.getElementById('system-type');
		const systemTypeOtherInput = document.getElementById('system-type-other');
		if (systemTypeOtherInput) {
			systemTypeOtherInput.value = '';
			systemTypeOtherInput.style.display = 'none';
		}
		['protocolos_suportados', 'capacidades_dados', 'requisitos_autenticacao'].forEach(id => {
			const select = document.getElementById(id);
			if (!select) return;
			Array.from(select.options).forEach(opt => { opt.selected = false; });
		});
		['protocolos_suportados_outro', 'capacidades_dados_outro', 'requisitos_autenticacao_outro'].forEach(id => {
			const input = document.getElementById(id);
			if (input) {
				input.value = '';
				input.style.display = 'none';
			}
		});
		toggleOtherField(systemTypeSelect, systemTypeOtherInput);
		ensureAutoIds();
	}

	function clearInterfaceForm() {
		const form = document.getElementById('interface-form');
		if (!form) return;
		form.reset();
		editingInterfaceId = null;
		const saveBtn = document.getElementById('interface-save-btn');
		if (saveBtn) saveBtn.textContent = 'Salvar interface';
		Object.values(interfaceBlocks).forEach(el => { if (el) el.style.display = 'none'; });
		document.querySelectorAll('input[name="http_methods"]').forEach(cb => { cb.checked = false; });
		const authSelect = document.getElementById('autenticacao');
		if (authSelect) Array.from(authSelect.options).forEach(opt => { opt.selected = false; });
		const authOtherInput = document.getElementById('autenticacao_outro');
		if (authOtherInput) {
			authOtherInput.value = '';
			authOtherInput.style.display = 'none';
		}
		const formatOtherInput = document.getElementById('interface-data-format-other');
		if (formatOtherInput) {
			formatOtherInput.value = '';
			formatOtherInput.style.display = 'none';
		}
		const interfaceTypeOtherInput = document.getElementById('interface-type-other');
		if (interfaceTypeOtherInput) {
			interfaceTypeOtherInput.value = '';
			interfaceTypeOtherInput.style.display = 'none';
		}
		ensureAutoIds();
	}

	function clearIntegrationForm() {
		const form = document.getElementById('integration-form');
		if (!form) return;
		form.reset();
		editingIntegrationId = null;
		const saveBtn = document.getElementById('integration-save-btn');
		if (saveBtn) saveBtn.textContent = 'Salvar integração';
		Object.values(styleBlocks).forEach(el => { if (el) el.style.display = 'none'; });
		const styleOther = document.getElementById('integration-style-other');
		if (styleOther) {
			styleOther.value = '';
			styleOther.style.display = 'none';
		}
		const interfacesSelect = document.getElementById('integration-interfaces');
		if (interfacesSelect) Array.from(interfacesSelect.options).forEach(opt => { opt.selected = false; });
	}

	function openAccordion(collapseId, buttonId) {
		const collapseEl = document.getElementById(collapseId);
		const btnEl = document.getElementById(buttonId);
		if (btnEl) {
			btnEl.classList.remove('collapsed');
			btnEl.setAttribute('aria-expanded', 'true');
		}
		if (collapseEl && window.bootstrap?.Collapse) {
			const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
			instance.show();
		} else if (collapseEl) {
			collapseEl.classList.add('show');
		}
	}

	function generateShortId(prefix) {
		const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
		return `${prefix}-${rand}`;
	}

	function ensureAutoIds() {
		const systemIdInput = document.querySelector('input[name="system_identifier"]');
		if (systemIdInput && !systemIdInput.value) {
			systemIdInput.value = generateShortId('SYS');
		}
		const interfaceIdInput = document.querySelector('input[name="interface_identifier"]');
		if (interfaceIdInput && !interfaceIdInput.value) {
			interfaceIdInput.value = generateShortId('INT');
		}
	}

	document.getElementById('system-form').addEventListener('submit', async (e) => {
		e.preventDefault();
		const data = formToJSON(e.target, ['protocolos_suportados', 'capacidades_dados', 'requisitos_autenticacao']);
		if (data.tipo === 'Outro' && data.tipo_outro) {
			data.tipo = data.tipo_outro;
		}
		const url = editingSystemId ? `/api/${projectId}/systems/${editingSystemId}/` : `/api/${projectId}/systems/`;
		const resp = await fetch(url, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
			body: JSON.stringify(data),
			credentials: 'same-origin'
		});
		if (!resp.ok) {
			alert('Não foi possível salvar o sistema.');
			return;
		}
		e.target.reset();
		editingSystemId = null;
		document.getElementById('system-save-btn').textContent = 'Salvar sistema';
		ensureAutoIds();
		refreshLists();
	});

	document.getElementById('interface-form').addEventListener('submit', async (e) => {
		e.preventDefault();
		const data = formToJSON(e.target, ['autenticacao', 'http_methods']);
		if (data.tipo === 'Outro' && data.tipo_outro) {
			data.tipo = data.tipo_outro;
		}
		const detalhes = {};
		if (data.tipo === 'REST API' || data.tipo === 'SOAP') {
			detalhes.http_methods = data.http_methods || [];
			detalhes.formato_dados = data.formato_dados || '';
			if (data.formato_dados === 'Outro' && data.formato_dados_outro) {
				detalhes.formato_dados = data.formato_dados_outro;
			}
			detalhes.json_schema = data.esquema || '';
			detalhes.example_payload = data.exemplo_dados || '';
		}
		if (data.tipo === 'WebSocket') {
			detalhes.connection_endpoint = data.connection_endpoint || '';
			detalhes.statefulness = data.statefulness || '';
			detalhes.reconnection_policy = data.reconnection_policy || '';
		}
		if (data.tipo === 'File-based') {
			detalhes.file_type = data.file_type || '';
			detalhes.transfer_protocol = data.transfer_protocol || '';
			detalhes.storage_location = data.storage_location || '';
			detalhes.processing_mode = data.processing_mode || '';
		}
		if (data.tipo === 'Messaging') {
			detalhes.broker_type = data.broker_type || '';
			detalhes.topic_or_queue = data.topic_or_queue || '';
			detalhes.message_format = data.message_format || '';
			detalhes.delivery_guarantees = data.delivery_guarantees || '';
		}
		if (data.tipo === 'Database Access') {
			detalhes.db_access = data.db_access || '';
		}
		if (data.autenticacao_outro) {
			detalhes.autenticacao_outro = data.autenticacao_outro;
		}
		data.detalhes = detalhes;
		const url = editingInterfaceId ? `/api/${projectId}/interfaces/${editingInterfaceId}/` : `/api/${projectId}/interfaces/`;
		const resp = await fetch(url, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
			body: JSON.stringify(data),
			credentials: 'same-origin'
		});
		if (!resp.ok) {
			alert('Não foi possível salvar a interface.');
			return;
		}
		e.target.reset();
		editingInterfaceId = null;
		document.getElementById('interface-save-btn').textContent = 'Salvar interface';
		ensureAutoIds();
		refreshLists();
	});

	document.getElementById('integration-form').addEventListener('submit', async (e) => {
		e.preventDefault();
		const data = formToJSON(e.target, ['interfaces_usadas']);
		const estilo = data.estilo;
		if (data.estilo === 'Outro' && data.estilo_outro) {
			data.estilo = data.estilo_outro;
		}
		const detalhes = {};
		if (estilo === 'Database Sharing') {
			detalhes.database_type = data.database_type || '';
			detalhes.shared_tables_or_views = data.shared_tables_or_views || '';
			detalhes.sync_mode = data.sync_mode || '';
		}
		if (estilo === 'Messaging') {
			detalhes.broker = data.broker || '';
			detalhes.topic_or_queue = data.topic_or_queue || '';
			detalhes.message_format = data.message_format || '';
			detalhes.processing_guarantees = data.processing_guarantees || '';
		}
		if (estilo === 'RPC') {
			detalhes.rpc_endpoint = data.rpc_endpoint || '';
			detalhes.rpc_mode = data.rpc_mode || '';
		}
		if (estilo === 'File Transfer') {
			detalhes.file_type = data.file_type || '';
			detalhes.transfer_protocol = data.transfer_protocol || '';
			detalhes.storage_location = data.storage_location || '';
			detalhes.transformation_type = data.transformation_type || '';
			if (data.transformation_type === 'Outro' && data.transformation_type_other) {
				detalhes.transformation_type = data.transformation_type_other;
			}
		}
		data.detalhes = detalhes;
		const url = editingIntegrationId ? `/api/${projectId}/integrations/${editingIntegrationId}/` : `/api/${projectId}/integrations/`;
		const resp = await fetch(url, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
			body: JSON.stringify(data),
			credentials: 'same-origin'
		});
		if (!resp.ok) {
			alert('Não foi possível salvar o estilo de integração.');
			return;
		}
		e.target.reset();
		editingIntegrationId = null;
		document.getElementById('integration-save-btn').textContent = 'Salvar integração';
		refreshLists();
	});

	document.getElementById('send-btn').addEventListener('click', async () => {
		errorMsg.style.display = 'none';
		const text = 'Analisar integração com base nos dados fornecidos.';

		if (systems.length < 2 || interfaces.length < 1 || integrations.length < 1) {
			errorMsg.textContent = 'Preencha as informações dos sistemas, interfaces e integrações antes de consultar.';
			errorMsg.style.display = 'block';
			return;
		}

		setStreamingState(true);
		scrollToChatArea();
		// sem input de texto do usuário

		const userMsg = { role: 'user', content: text };
		messages.push(userMsg);
		renderMessages();

		const resp = await fetch(`/chat/stream/`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
			body: JSON.stringify({ message: text, lang: currentLang }),
			credentials: 'same-origin'
		});

		if (!resp.ok) {
			let errorText = 'Erro ao consultar.';
			const raw = await resp.text();
			if (raw) {
				try {
					const err = JSON.parse(raw);
					errorText = err.error || errorText;
				} catch (e) {
					errorText = raw;
				}
			}
			errorMsg.textContent = errorText;
			errorMsg.style.display = 'block';
			setStreamingState(false);
			return;
		}

		const reader = resp.body.getReader();
		const decoder = new TextDecoder();
		let assistantContent = '';
		const assistantMsg = { role: 'assistant', content: '' };
		messages.push(assistantMsg);
		renderMessages();

		let buffer = '';
		while (true) {
			const { value, done } = await reader.read();
			if (done) break;
			buffer += decoder.decode(value, { stream: true });
			const parts = buffer.split('\n\n');
			buffer = parts.pop();

			for (const part of parts) {
				if (part.startsWith('event: prompt')) {
					const data = part.split('\n').find(l => l.startsWith('data: '));
					if (data) {
						promptRaw = JSON.parse(data.replace('data: ', ''));
						promptBox.textContent = promptRaw;
					}
				}
				if (part.startsWith('event: token')) {
					const data = part.split('\n').find(l => l.startsWith('data: '));
					if (data) {
						assistantContent += JSON.parse(data.replace('data: ', ''));
						assistantMsg.content = assistantContent;
						renderMessages();
						scrollToChatArea();
					}
				}
				if (part.startsWith('event: error')) {
					const data = part.split('\n').find(l => l.startsWith('data: '));
					if (data) {
						errorMsg.textContent = JSON.parse(data.replace('data: ', ''));
						errorMsg.style.display = 'block';
					}
				}
			}
		}
		setStreamingState(false);
	});

	document.getElementById('clear-btn').addEventListener('click', () => {
		fetch(`/api/${projectId}/chat/clear/`, {
			method: 'POST',
			headers: { 'X-CSRFToken': csrfToken }
		}).then(() => {
			messages.length = 0;
			renderMessages();
			promptBox.textContent = '(O prompt aparecerá aqui após a consulta.)';
		});
	});

	if (jumpBtn) {
		jumpBtn.addEventListener('click', () => {
			if (jumpBtn.dataset.jump === 'up') {
				window.scrollTo({ top: 0, behavior: 'smooth' });
			} else {
				window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
			}
		});
		window.addEventListener('scroll', updateJumpButtonState, { passive: true });
		window.addEventListener('resize', updateJumpButtonState);
		updateJumpButtonState();
	}

	async function loadChatList() {
		const container = document.getElementById('chat-list');
		try {
			const resp = await fetch('/api/chats/', { credentials: 'same-origin' });
			const contentType = resp.headers.get('content-type') || '';
			if (!resp.ok || !contentType.includes('application/json')) {
				container.innerHTML = `<div class="small text-muted">${t('session_expired')}</div>`;
				return;
			}
			const data = await resp.json();
			if (!data.projects || data.projects.length === 0) {
				container.innerHTML = `<div class="small text-muted">${t('no_conversations')}</div>`;
				return;
			}
			container.innerHTML = data.projects.map(p => `
				<div class="chat-item">
					<button type="button" class="chat-link select-chat-btn" data-id="${p.id}">${p.nome}</button>
					<div class="chat-item-actions">
						<button type="button" title="Excluir conversa" data-id="${p.id}" class="delete-chat-btn">
							<i class="bi bi-trash"></i>
						</button>
					</div>
				</div>
			`).join('');
		} catch (e) {
			container.innerHTML = `<div class="small text-muted">${t('load_chats_error')}</div>`;
			return;
		}
	}

	applyTranslations();
	renderMessages();
	promptRaw = getLatestPromptUsed();
	if (promptRaw) {
		promptBox.textContent = promptRaw;
	}
	refreshLists();
	loadChatList();
	ensureAutoIds();

	const langToggle = document.getElementById('lang-toggle');
	if (langToggle) {
		langToggle.value = currentLang;
		langToggle.addEventListener('change', (e) => {
			setLanguage(e.target.value);
		});
	}

	const chatList = document.getElementById('chat-list');
	if (chatList) {
		chatList.addEventListener('click', async (e) => {
			const deleteBtn = e.target.closest('.delete-chat-btn');
			const selectBtn = e.target.closest('.select-chat-btn');
			if (!deleteBtn && !selectBtn) return;

			e.preventDefault();
			e.stopPropagation();

			if (deleteBtn) {
				const id = deleteBtn.getAttribute('data-id');
				if (!confirm('Excluir esta conversa?')) return;
				const deleteResp = await fetch(`/api/${id}/chat/delete/`, {
					method: 'POST',
					headers: { 'X-CSRFToken': getCsrfToken() },
					credentials: 'same-origin'
				});
				if (!deleteResp.ok) {
					alert('Não foi possível excluir a conversa. Recarregue a página e tente novamente.');
					return;
				}
				const listResp = await fetch('/api/chats/', { credentials: 'same-origin' });
				const data = await listResp.json();
				if (String(id) === String(projectId)) {
					if (data.projects && data.projects.length > 0) {
						await fetch(`/api/chat/select/${data.projects[0].id}/`, {
							method: 'POST',
							headers: { 'X-CSRFToken': getCsrfToken() },
							credentials: 'same-origin'
						});
						window.location.href = '/chat/';
					} else {
						window.location.href = '/';
					}
				} else {
					loadChatList();
				}
				return;
			}

			if (selectBtn) {
				const id = selectBtn.getAttribute('data-id');
				const selectResp = await fetch(`/api/chat/select/${id}/`, {
					method: 'POST',
					headers: { 'X-CSRFToken': getCsrfToken() },
					credentials: 'same-origin'
				});
				if (!selectResp.ok) {
					alert('Não foi possível abrir a conversa.');
					return;
				}
				window.location.href = '/chat/';
			}
		});
	}

	// Edit/Delete handlers
	document.addEventListener('click', async (e) => {
		if (e.target.closest('.delete-system')) {
			const id = e.target.closest('.delete-system').dataset.id;
			if (!confirm('Excluir este sistema?')) return;
			const resp = await fetch(`/api/${projectId}/systems/${id}/`, {
				method: 'DELETE',
				headers: { 'X-CSRFToken': getCsrfToken() },
				credentials: 'same-origin'
			});
			if (!resp.ok) {
				alert('Não foi possível excluir o sistema.');
				return;
			}
			if (String(editingSystemId) === String(id)) {
				clearSystemForm();
			}
			refreshLists();
			return;
		}

		if (e.target.closest('.delete-interface')) {
			const id = e.target.closest('.delete-interface').dataset.id;
			if (!confirm('Excluir esta interface?')) return;
			const resp = await fetch(`/api/${projectId}/interfaces/${id}/`, {
				method: 'DELETE',
				headers: { 'X-CSRFToken': getCsrfToken() },
				credentials: 'same-origin'
			});
			if (!resp.ok) {
				alert('Não foi possível excluir a interface.');
				return;
			}
			if (String(editingInterfaceId) === String(id)) {
				clearInterfaceForm();
			}
			refreshLists();
			return;
		}

		if (e.target.closest('.delete-integration')) {
			const id = e.target.closest('.delete-integration').dataset.id;
			if (!confirm('Excluir este estilo de integração?')) return;
			const resp = await fetch(`/api/${projectId}/integrations/${id}/`, {
				method: 'DELETE',
				headers: { 'X-CSRFToken': getCsrfToken() },
				credentials: 'same-origin'
			});
			if (!resp.ok) {
				alert('Não foi possível excluir o estilo de integração.');
				return;
			}
			if (String(editingIntegrationId) === String(id)) {
				clearIntegrationForm();
			}
			refreshLists();
			return;
		}

		const systemCard = e.target.closest('.system-item');
		const interfaceCard = e.target.closest('.interface-item');
		const integrationCard = e.target.closest('.integration-item');

		if (e.target.closest('.edit-system') || systemCard) {
			const id = (e.target.closest('.edit-system') || systemCard).dataset.id;
			const s = systems.find(x => String(x.id) === String(id));
			if (!s) return;
			editingSystemId = s.id;
			document.getElementById('system-save-btn').textContent = 'Atualizar sistema';
			const form = document.getElementById('system-form');
			form.system_identifier.value = s.system_identifier || '';
			form.nome.value = s.nome || '';
			form.descricao.value = s.descricao || '';
			form.tipo.value = s.tipo || '';
			const systemTypeSelect = document.getElementById('system-type');
			const systemTypeOtherInput = document.getElementById('system-type-other');
			if (systemTypeSelect && systemTypeOtherInput && s.tipo) {
				const hasOption = Array.from(systemTypeSelect.options).some(opt => opt.value === s.tipo);
				if (!hasOption) {
					systemTypeSelect.value = 'Outro';
					systemTypeOtherInput.style.display = 'block';
					systemTypeOtherInput.value = s.tipo;
				} else {
					systemTypeOtherInput.style.display = 'none';
					systemTypeOtherInput.value = '';
				}
			}
			form.integration_role.value = s.integration_role || '';
			form.primary_function_in_flow.value = s.primary_function_in_flow || '';
			form.versao.value = s.versao || '';
			form.technical_contact.value = s.technical_contact || '';
			form.architectural_notes.value = s.architectural_notes || '';
			// multi fields
			const setMulti = (select, value) => {
				const arr = (value || '').split(',').map(v => v.trim()).filter(Boolean);
				Array.from(select.options).forEach(opt => { opt.selected = arr.includes(opt.value); });
			};
			setMulti(document.getElementById('protocolos_suportados'), s.protocolos_suportados);
			setMulti(document.getElementById('capacidades_dados'), s.capacidades_dados);
			setMulti(document.getElementById('requisitos_autenticacao'), s.requisitos_autenticacao);
			const protocolosOutro = document.getElementById('protocolos_suportados_outro');
			const formatosOutro = document.getElementById('capacidades_dados_outro');
			const authOutro = document.getElementById('requisitos_autenticacao_outro');
			if (protocolosOutro) protocolosOutro.value = s.protocolos_suportados_outro || '';
			if (formatosOutro) formatosOutro.value = s.capacidades_dados_outro || '';
			if (authOutro) authOutro.value = s.requisitos_autenticacao_outro || '';
			toggleOtherField(systemTypeSelect, systemTypeOtherInput);
			toggleOtherField(document.getElementById('protocolos_suportados'), protocolosOutro);
			toggleOtherField(document.getElementById('capacidades_dados'), formatosOutro);
			toggleOtherField(document.getElementById('requisitos_autenticacao'), authOutro);
			openAccordion('collapseSystems', 'acc-systems');
		}

		if (e.target.closest('.edit-interface') || interfaceCard) {
			const id = (e.target.closest('.edit-interface') || interfaceCard).dataset.id;
			const i = interfaces.find(x => String(x.id) === String(id));
			if (!i) return;
			editingInterfaceId = i.id;
			document.getElementById('interface-save-btn').textContent = 'Atualizar interface';
			const form = document.getElementById('interface-form');
			form.interface_identifier.value = i.interface_identifier || '';
			form.sistema_id.value = i.sistema_id || '';
			form.nome.value = i.nome || '';
			form.tipo.value = i.tipo || '';
			const interfaceTypeSelect = document.getElementById('interface-type');
			const interfaceTypeOtherInput = document.getElementById('interface-type-other');
			if (interfaceTypeSelect && interfaceTypeOtherInput && i.tipo) {
				const hasOption = Array.from(interfaceTypeSelect.options).some(opt => opt.value === i.tipo);
				if (!hasOption) {
					interfaceTypeSelect.value = 'Outro';
					interfaceTypeOtherInput.style.display = 'block';
					interfaceTypeOtherInput.value = i.tipo;
				} else {
					interfaceTypeOtherInput.style.display = 'none';
					interfaceTypeOtherInput.value = '';
				}
			}
			if (interfaceTypeSelect) {
				Object.values(interfaceBlocks).forEach(el => { if (el) el.style.display = 'none'; });
				const block = interfaceBlocks[interfaceTypeSelect.value];
				if (block) block.style.display = 'block';
			}
			form.endpoint.value = i.endpoint || '';
			form.formato_dados.value = i.formato_dados || '';
			const metodosPermitidosField = form.querySelector('[name="metodos_permitidos"]');
			if (metodosPermitidosField) {
				metodosPermitidosField.value = i.metodos_permitidos || '';
			}
			let details = {};
			if (i.detalhes) {
				try {
					details = typeof i.detalhes === 'string' ? JSON.parse(i.detalhes) : i.detalhes;
				} catch (e) {
					details = {};
				}
			}

			form.operacoes_suportadas.value = i.operacoes_suportadas || details.operacoes_suportadas || '';
			form.esquema.value = i.esquema || details.json_schema || details.schema || '';
			form.exemplo_dados.value = i.exemplo_dados || details.example_payload || details.example || '';
			form.throttling.value = i.throttling || details.throttling || '';
			form.throttling_unit.value = i.throttling_unit || details.throttling_unit || '';
			form.technical_interface_notes.value = i.technical_interface_notes || details.technical_interface_notes || details.descricao || '';
			const authSelect = document.getElementById('autenticacao');
			const authArr = (i.autenticacao || '').split(',').map(v => v.trim()).filter(Boolean);
			Array.from(authSelect.options).forEach(opt => { opt.selected = authArr.includes(opt.value); });
			const authOtherInput = document.getElementById('autenticacao_outro');
			if (authOtherInput) {
				authOtherInput.value = (i.detalhes && i.detalhes.autenticacao_outro) ? i.detalhes.autenticacao_outro : '';
				toggleOtherField(authSelect, authOtherInput);
			}

			if (i.tipo === 'REST API' || i.tipo === 'SOAP') {
				const methods = details.http_methods || (i.metodos_permitidos ? i.metodos_permitidos.split(',').map(v => v.trim()).filter(Boolean) : []);
				document.querySelectorAll('input[name="http_methods"]').forEach(cb => {
					cb.checked = methods.includes(cb.value);
				});
				form.formato_dados.value = details.formato_dados || i.formato_dados || '';
				const formatOtherInput = document.getElementById('interface-data-format-other');
				if (formatOtherInput && form.formato_dados.value && !Array.from(form.formato_dados.options).some(opt => opt.value === form.formato_dados.value)) {
					form.formato_dados.value = 'Outro';
					formatOtherInput.style.display = 'block';
					formatOtherInput.value = details.formato_dados || '';
				} else if (formatOtherInput) {
					toggleOtherField(document.getElementById('interface-data-format'), formatOtherInput);
				}
				form.esquema.value = details.json_schema || i.esquema || details.schema || '';
				form.exemplo_dados.value = details.example_payload || i.exemplo_dados || details.example || '';
			}
			if (i.tipo === 'WebSocket') {
				form.connection_endpoint.value = details.connection_endpoint || '';
				form.statefulness.value = details.statefulness || '';
				form.reconnection_policy.value = details.reconnection_policy || '';
			}
			if (i.tipo === 'File-based') {
				form.file_type.value = details.file_type || '';
				form.transfer_protocol.value = details.transfer_protocol || '';
				form.storage_location.value = details.storage_location || '';
				form.processing_mode.value = details.processing_mode || '';
			}
			if (i.tipo === 'Messaging') {
				form.broker_type.value = details.broker_type || '';
				form.topic_or_queue.value = details.topic_or_queue || '';
				form.message_format.value = details.message_format || '';
				form.delivery_guarantees.value = details.delivery_guarantees || '';
			}
			if (i.tipo === 'Database Access') {
				form.db_access.value = details.db_access || '';
			}
			openAccordion('collapseInterfaces', 'acc-interfaces');
		}

		if (e.target.closest('.edit-integration') || integrationCard) {
			const id = (e.target.closest('.edit-integration') || integrationCard).dataset.id;
			const integ = integrations.find(x => String(x.id) === String(id));
			if (!integ) return;
			editingIntegrationId = integ.id;
			document.getElementById('integration-save-btn').textContent = 'Atualizar integração';
			const form = document.getElementById('integration-form');
			form.sistema_origem_id.value = integ.sistema_origem_id || '';
			form.sistema_destino_id.value = integ.sistema_destino_id || '';
			form.estilo.value = integ.estilo || '';
			form.estilo_outro.value = integ.estilo_outro || '';
			const estiloSelect = document.getElementById('integration-style');
			const estiloOtherInput = document.getElementById('integration-style-other');
			if (estiloSelect && estiloOtherInput && integ.estilo) {
				const hasOption = Array.from(estiloSelect.options).some(opt => opt.value === integ.estilo);
				if (!hasOption) {
					estiloSelect.value = 'Outro';
					estiloOtherInput.style.display = 'block';
					estiloOtherInput.value = integ.estilo;
				} else {
					estiloOtherInput.style.display = 'none';
				}
			}
			form.architectural_rationale.value = integ.architectural_rationale || '';

			const interfacesSelect = document.getElementById('integration-interfaces');
			if (interfacesSelect) {
				const arr = (integ.interfaces_usadas || []).map(v => String(v));
				Array.from(interfacesSelect.options).forEach(opt => {
					opt.selected = arr.includes(String(opt.value));
				});
			}

			// open the proper section
			const block = styleBlocks[integ.estilo];
			Object.values(styleBlocks).forEach(el => { if (el) el.style.display = 'none'; });
			if (block) block.style.display = 'block';

			const d = integ.detalhes || {};
			if (integ.estilo === 'Database Sharing') {
				form.database_type.value = d.database_type || '';
				form.shared_tables_or_views.value = d.shared_tables_or_views || '';
				form.sync_mode.value = d.sync_mode || '';
			}
			if (integ.estilo === 'Messaging') {
				form.broker.value = d.broker || '';
				form.topic_or_queue.value = d.topic_or_queue || '';
				form.message_format.value = d.message_format || '';
				form.processing_guarantees.value = d.processing_guarantees || '';
			}
			if (integ.estilo === 'RPC') {
				form.rpc_endpoint.value = d.rpc_endpoint || '';
				form.rpc_mode.value = d.rpc_mode || '';
			}
			if (integ.estilo === 'File Transfer') {
				form.file_type.value = d.file_type || '';
				form.transfer_protocol.value = d.transfer_protocol || '';
				form.storage_location.value = d.storage_location || '';
				form.transformation_type.value = d.transformation_type || '';
				form.transformation_type_other.value = d.transformation_type_other || '';
				const transOtherInput = document.getElementById('transformation_type_other');
				if (transOtherInput) {
					toggleOtherField(document.querySelector('select[name="transformation_type"]'), transOtherInput);
				}
			}
			openAccordion('collapseIntegrations', 'acc-integrations');
		}
	});

	// Prompt interactions (read-only)
	const promptToggle = document.getElementById('prompt-toggle');
	const promptCopy = document.getElementById('prompt-copy');
	const promptDownload = document.getElementById('prompt-download');
	let promptExpanded = false;

	if (promptToggle) {
		promptToggle.addEventListener('click', () => {
			promptExpanded = !promptExpanded;
			promptBox.style.maxHeight = promptExpanded ? '60vh' : '240px';
			promptToggle.innerHTML = promptExpanded
				? `<i class="bi bi-arrows-angle-contract me-1"></i>${t('reduce')}`
				: `<i class="bi bi-arrows-angle-expand me-1"></i>${t('expand')}`;
		});
	}


	if (promptCopy) {
		promptCopy.addEventListener('click', async () => {
			try {
				await navigator.clipboard.writeText(promptRaw || promptBox.textContent || '');
				promptCopy.innerHTML = `<i class="bi bi-check2 me-1"></i>${t('prompt_copied')}`;
				setTimeout(() => {
					promptCopy.innerHTML = `<i class="bi bi-clipboard me-1"></i>${t('copy')}`;
				}, 1500);
			} catch (e) {
				alert('Não foi possível copiar.');
			}
		});
	}

	if (promptDownload) {
		promptDownload.addEventListener('click', () => {
			const blob = new Blob([promptRaw || promptBox.textContent || ''], { type: 'text/markdown;charset=utf-8' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `prompt-${projectId}.md`;
			document.body.appendChild(a);
			a.click();
			a.remove();
			URL.revokeObjectURL(url);
		});
	}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
